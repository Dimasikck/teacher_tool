{% extends 'base.html' %}
{% block title %}Yandex Disk - Облачные файлы{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Заголовок -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-cloud"></i> Yandex Disk - Облачные файлы</h2>
        <div>
            <button class="btn btn-primary" onclick="showSettingsModal()">
                <i class="bi bi-gear"></i> Настройки
            </button>
            <button class="btn btn-success" onclick="uploadFile()">
                <i class="bi bi-cloud-upload"></i> Загрузить файл
            </button>
            <button class="btn btn-info" onclick="refreshFiles()">
                <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
        </div>
    </div>

    <!-- Статус подключения -->
    <div class="row mb-4">
        <div class="col-12">
            <div id="connectionStatus" class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Подключение не настроено</strong> - Нажмите "Настройки" для подключения к Yandex Disk
            </div>
        </div>
    </div>

    <!-- Навигация по папкам -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="bi bi-folder"></i> Текущая папка: 
                        <span id="currentPath" class="text-primary">/</span>
                    </div>
                    <div class="input-group" style="max-width: 400px;">
                        <input type="text" class="form-control" id="pathInput" placeholder="/путь/к/папке" value="/">
                        <button class="btn btn-outline-secondary" onclick="navigateToPath()">
                            <i class="bi bi-arrow-right"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="goToRoot()" title="Корень">
                            <i class="bi bi-house"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <nav aria-label="breadcrumb">
                        <ol id="breadcrumb" class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a href="#" onclick="goToRoot()">Корень</a></li>
                        </ol>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Список файлов и папок -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-files"></i> Файлы и папки
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-outline-secondary" onclick="toggleView('grid')" id="gridViewBtn">
                            <i class="bi bi-grid-3x3-gap"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="toggleView('list')" id="listViewBtn">
                            <i class="bi bi-list"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="filesContainer" class="row">
                        <!-- Файлы будут загружены динамически -->
                        <div class="col-12 text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <p class="mt-3 text-muted">Загрузка файлов...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно настроек -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Настройки Yandex Disk</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <div class="fw-bold mb-1">Инструкция по настройке:</div>
                        <div class="small">
                            1) Перейдите на <a href="https://oauth.yandex.ru/" target="_blank">https://oauth.yandex.ru/</a><br>
                            2) Создайте новое приложение<br>
                            3) Установите Redirect URI: <code>https://oauth.yandex.ru/verification_code</code><br>
                            4) Скопируйте Client ID и Client Secret<br>
                            5) Введите данные в форму ниже<br>
                            6) Нажмите "Получить токен" для авторизации
                        </div>
                    </div>
                    <form id="settingsForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="clientId" class="form-label">Client ID</label>
                                    <input type="text" class="form-control" id="clientId" name="client_id" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="clientSecret" class="form-label">Client Secret</label>
                                    <input type="password" class="form-control" id="clientSecret" name="client_secret" required>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="accessToken" class="form-label">Access Token</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="accessToken" name="access_token" placeholder="Введите токен вручную или получите автоматически">
                                <button class="btn btn-outline-primary" type="button" onclick="getAccessToken()">
                                    <i class="bi bi-key"></i> Получить токен
                                </button>
                            </div>
                            <div class="form-text">Можно ввести код подтверждения (короткий) или токен доступа (длинный) вручную, либо получить автоматически</div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isActive" name="is_active">
                                <label class="form-check-label" for="isActive">
                                    Активировать подключение
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <button type="button" class="btn btn-outline-info" onclick="testConnection()">
                                <i class="bi bi-wifi"></i> Тестировать подключение
                            </button>
                            <div id="testResult" class="mt-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно загрузки файла -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> Загрузить файл</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">Выберите файл</label>
                            <input type="file" class="form-control" id="fileInput" name="file" required>
                            <div class="form-text">Поддерживаемые форматы: PDF, DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT, изображения, архивы</div>
                        </div>
                        <div class="mb-3">
                            <label for="uploadPath" class="form-label">Папка назначения</label>
                            <input type="text" class="form-control" id="uploadPath" name="path" value="/">
                            <div class="form-text">Путь в Yandex Disk, куда загрузить файл</div>
                        </div>
                        <div class="progress mb-3" style="display: none;" id="uploadProgress">
                            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="startUpload()">Загрузить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра файла -->
    <div class="modal fade" id="viewModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="viewModalTitle">
                        <i class="bi bi-file-earmark"></i> Просмотр файла
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="fileViewer">
                        <!-- Содержимое файла будет загружено динамически -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-primary" onclick="downloadCurrentFile()">
                        <i class="bi bi-download"></i> Скачать
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Стили для файлов и папок с поддержкой темной темы */
.file-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    border: 1px solid var(--border-light);
    margin-bottom: 1rem;
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.file-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.file-item:hover::before {
    opacity: 1;
}

.file-item:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 30px var(--shadow-medium);
    border-color: var(--border-color);
}

.file-item.folder {
    background: var(--accent-gradient);
    color: white;
    border: none;
}

.file-item.folder:hover {
    transform: translateY(-6px) scale(1.03);
    box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
}

.file-item.file {
    background: var(--bg-card);
    color: var(--text-primary);
}

.file-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
    transition: transform 0.3s ease;
}

.file-item:hover .file-icon {
    transform: scale(1.1);
}

.file-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: inherit;
    word-break: break-word;
}

.file-meta {
    font-size: 0.875rem;
    color: var(--text-muted);
    opacity: 0.8;
}

.grid-view .file-item {
    height: 200px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 1.5rem;
}

.list-view .file-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    height: auto;
    min-height: 80px;
}

.list-view .file-icon {
    font-size: 1.5rem;
    margin-right: 1rem;
    margin-bottom: 0;
}

.list-view .file-info {
    flex: 1;
}

.file-actions {
    opacity: 0;
    transition: opacity 0.3s ease;
    display: flex;
    gap: 0.5rem;
}

.file-item:hover .file-actions {
    opacity: 1;
}

.breadcrumb-item a {
    color: var(--accent-primary);
    text-decoration: none;
    transition: color 0.3s ease;
}

.breadcrumb-item a:hover {
    color: var(--accent-secondary);
    text-decoration: underline;
}

#fileViewer {
    max-height: 500px;
    overflow-y: auto;
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 1.5rem;
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
}

.file-preview {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 20px var(--shadow-light);
}

.text-preview {
    white-space: pre-wrap;
    font-family: 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    color: var(--text-primary);
    background: var(--bg-secondary);
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

#connectionStatus {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
    font-weight: 500;
    border: 1px solid var(--border-light);
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

#connectionStatus.connected {
    background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
    color: white;
    border-color: var(--success-color);
}

#connectionStatus.disconnected {
    background: linear-gradient(135deg, var(--error-color) 0%, #e53e3e 100%);
    color: white;
    border-color: var(--error-color);
}

#connectionStatus.connecting {
    background: linear-gradient(135deg, var(--warning-color) 0%, #dd6b20 100%);
    color: white;
    border-color: var(--warning-color);
}

/* Стили для модальных окон */
.modal-content {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    box-shadow: 0 20px 60px var(--shadow-dark);
}

.modal-header {
    background: var(--bg-glass);
    border-bottom: 1px solid var(--border-light);
    border-radius: 16px 16px 0 0;
}

.modal-footer {
    background: var(--bg-glass);
    border-top: 1px solid var(--border-light);
    border-radius: 0 0 16px 16px;
}

.modal-title {
    color: var(--text-primary);
    font-weight: 600;
}

/* Стили для форм */
.form-control, .form-select {
    background: var(--input-bg);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 12px 16px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.form-control:focus, .form-select:focus {
    background: var(--input-bg);
    color: var(--text-primary);
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 3px var(--input-focus);
    outline: none;
}

.form-control::placeholder {
    color: var(--text-muted);
}

.form-label {
    color: var(--text-primary);
    font-weight: 500;
    margin-bottom: 8px;
    letter-spacing: 0.5px;
}

.form-text {
    color: var(--text-muted);
    font-size: 0.875rem;
}

/* Стили для карточек */
.card {
    background: var(--bg-card);
    backdrop-filter: blur(20px);
    color: var(--text-primary);
    border: 1px solid var(--border-light);
    border-radius: 16px;
    box-shadow: 0 4px 20px var(--shadow-light);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
}

.card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: var(--accent-gradient);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.card:hover::before {
    opacity: 1;
}

.card:hover {
    transform: translateY(-4px) scale(1.01);
    box-shadow: 0 8px 30px var(--shadow-medium);
    border-color: var(--border-color);
}

.card-header {
    background: var(--bg-glass);
    border-bottom: 1px solid var(--border-light);
    border-radius: 16px 16px 0 0;
    font-weight: 600;
    color: var(--text-primary);
    padding: 1.25rem 1.5rem;
}

.card-body {
    padding: 1.5rem;
    color: var(--text-primary);
}

/* Стили для кнопок */
.btn {
    border-radius: 12px;
    font-weight: 500;
    letter-spacing: 0.5px;
    padding: 12px 24px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    border: none;
}

.btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
}

.btn:hover::before {
    left: 100%;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px var(--shadow-medium);
}

.btn-primary {
    background: var(--accent-gradient);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.btn-secondary {
    background: var(--bg-card);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
    backdrop-filter: blur(20px);
}

.btn-secondary:hover {
    background: var(--hover-bg);
    transform: translateY(-2px);
}

.btn-success {
    background: linear-gradient(135deg, var(--success-color) 0%, #38a169 100%);
    color: white;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(72, 187, 120, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, var(--error-color) 0%, #e53e3e 100%);
    color: white;
}

.btn-danger:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
}

.btn-warning {
    background: linear-gradient(135deg, var(--warning-color) 0%, #dd6b20 100%);
    color: white;
}

.btn-warning:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(237, 137, 54, 0.4);
}

.btn-info {
    background: linear-gradient(135deg, var(--info-color) 0%, #3182ce 100%);
    color: white;
}

.btn-info:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(66, 153, 225, 0.4);
}

/* Адаптивность для мобильных устройств */
@media (max-width: 768px) {
    .file-item {
        margin-bottom: 0.75rem;
    }
    
    .grid-view .file-item {
        height: 160px;
        padding: 1rem;
    }
    
    .list-view .file-item {
        padding: 0.75rem;
        min-height: 60px;
    }
    
    .file-icon {
        font-size: 1.5rem;
    }
    
    .list-view .file-icon {
        font-size: 1.25rem;
    }
    
    .card-body {
        padding: 1rem;
    }
    
    .btn {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>

<script>
let currentPath = '/';
let currentView = 'grid';
let currentFile = null;
let settings = null;

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    loadFiles();
});

// === УПРАВЛЕНИЕ НАСТРОЙКАМИ ===

function showSettingsModal() {
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    modal.show();
}

function loadSettings() {
    fetch('/docs/api/yandex/settings')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.log('Настройки не найдены');
                updateConnectionStatus(false, 'Подключение не настроено');
                return;
            }
            
            settings = data;
            document.getElementById('clientId').value = data.client_id || '';
            document.getElementById('clientSecret').value = data.client_secret || '';
            document.getElementById('accessToken').value = data.access_token || '';
            document.getElementById('isActive').checked = data.is_active || false;
            
            updateConnectionStatus(data.is_active, data.is_active ? 'Подключено к Yandex Disk' : 'Подключение неактивно');
            
            if (data.is_active) {
                loadFiles();
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки настроек:', error);
            updateConnectionStatus(false, 'Ошибка загрузки настроек');
        });
}

function updateConnectionStatus(isConnected, message) {
    const statusDiv = document.getElementById('connectionStatus');
    if (isConnected) {
        statusDiv.className = 'alert alert-success';
        statusDiv.innerHTML = `<i class="bi bi-check-circle"></i> <strong>${message}</strong>`;
    } else {
        statusDiv.className = 'alert alert-warning';
        statusDiv.innerHTML = `<i class="bi bi-exclamation-triangle"></i> <strong>${message}</strong>`;
    }
}

function getAccessToken() {
    const clientId = document.getElementById('clientId').value;
    const clientSecret = document.getElementById('clientSecret').value;
    
    if (!clientId || !clientSecret) {
        showNotification('Заполните Client ID и Client Secret', 'warning');
        return;
    }
    
    // Открываем окно авторизации Yandex
    const authUrl = `https://oauth.yandex.ru/authorize?response_type=code&client_id=${clientId}&redirect_uri=${encodeURIComponent('https://oauth.yandex.ru/verification_code')}`;
    window.open(authUrl, 'yandex_auth', 'width=600,height=600,scrollbars=yes,resizable=yes');
}

function testConnection() {
    const resultDiv = document.getElementById('testResult');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2" role="status"></div>Тестирование подключения...';
    
    fetch('/docs/api/yandex/test-connection', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            client_id: document.getElementById('clientId').value,
            client_secret: document.getElementById('clientSecret').value,
            access_token: document.getElementById('accessToken').value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
            
            // Если получен токен доступа, обновляем поле
            if (data.access_token) {
                document.getElementById('accessToken').value = data.access_token;
                showNotification('Токен доступа получен и обновлен!', 'success');
            }
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> ${data.error}</div>`;
        }
    })
    .catch(error => {
        resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> Ошибка тестирования подключения</div>';
        console.error('Error:', error);
    });
}

function saveSettings() {
    const form = document.getElementById('settingsForm');
    const formData = new FormData(form);
    
    const data = {
        client_id: formData.get('client_id'),
        client_secret: formData.get('client_secret'),
        access_token: formData.get('access_token'),
        is_active: document.getElementById('isActive').checked
    };
    
    fetch('/docs/api/yandex/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
            modal.hide();
            loadSettings();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка сохранения настроек', 'error');
        console.error('Error:', error);
    });
}

// === НАВИГАЦИЯ ПО ПАПКАМ ===

function goToRoot() {
    currentPath = '/';
    updatePathDisplay();
    loadFiles();
}

function navigateToPath() {
    const path = document.getElementById('pathInput').value || '/';
    currentPath = path;
    updatePathDisplay();
    loadFiles();
}

function updatePathDisplay() {
    document.getElementById('currentPath').textContent = currentPath;
    document.getElementById('pathInput').value = currentPath;
    
    // Обновляем breadcrumb
    const breadcrumb = document.getElementById('breadcrumb');
    breadcrumb.innerHTML = '<li class="breadcrumb-item"><a href="#" onclick="goToRoot()">Корень</a></li>';
    
    if (currentPath !== '/') {
        const parts = currentPath.split('/').filter(part => part);
        let currentPartPath = '';
        
        parts.forEach((part, index) => {
            currentPartPath += '/' + part;
            const isLast = index === parts.length - 1;
            
            const li = document.createElement('li');
            li.className = 'breadcrumb-item';
            if (isLast) {
                li.className += ' active';
                li.textContent = part;
            } else {
                const a = document.createElement('a');
                a.href = '#';
                a.textContent = part;
                a.onclick = () => {
                    currentPath = currentPartPath;
                    updatePathDisplay();
                    loadFiles();
                };
                li.appendChild(a);
            }
            breadcrumb.appendChild(li);
        });
    }
}

function navigateToFolder(path) {
    currentPath = path;
    updatePathDisplay();
    loadFiles();
}

// === ЗАГРУЗКА ФАЙЛОВ ===

function loadFiles() {
    const container = document.getElementById('filesContainer');
    
    // Показываем индикатор загрузки
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3 text-muted">Загрузка файлов...</p>
        </div>
    `;
    
    fetch(`/docs/api/yandex/files?path=${encodeURIComponent(currentPath)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
                        <h4 class="mt-3 text-muted">Ошибка загрузки</h4>
                        <p class="text-muted">${data.error}</p>
                        <button class="btn btn-primary" onclick="loadFiles()">
                            <i class="bi bi-arrow-clockwise"></i> Попробовать снова
                        </button>
                    </div>
                `;
                return;
            }
            
            renderFiles(data.files || []);
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = `
                <div class="col-12 text-center py-5">
                    <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
                    <h4 class="mt-3 text-muted">Ошибка подключения</h4>
                    <p class="text-muted">Не удалось загрузить файлы</p>
                    <button class="btn btn-primary" onclick="loadFiles()">
                        <i class="bi bi-arrow-clockwise"></i> Попробовать снова
                    </button>
                </div>
            `;
        });
}

function renderFiles(files) {
    const container = document.getElementById('filesContainer');
    container.innerHTML = '';
    
    if (files.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-5">
                <i class="bi bi-folder-x" style="font-size: 4rem; color: #ccc;"></i>
                <h4 class="mt-3 text-muted">Папка пуста</h4>
                <p class="text-muted">Загрузите первый файл в эту папку</p>
                <button class="btn btn-primary" onclick="uploadFile()">
                    <i class="bi bi-cloud-upload"></i> Загрузить файл
                </button>
            </div>
        `;
        return;
    }
    
    files.forEach(file => {
        const fileElement = createFileElement(file);
        container.appendChild(fileElement);
    });
}

function createFileElement(file) {
    const col = document.createElement('div');
    col.className = currentView === 'grid' ? 'col-md-3 col-sm-6 mb-3' : 'col-12 mb-2';
    
    const isFolder = file.type === 'dir';
    const fileClass = isFolder ? 'folder' : 'file';
    
    if (currentView === 'grid') {
        col.innerHTML = `
            <div class="file-item ${fileClass}" onclick="${isFolder ? `navigateToFolder('${file.path}')` : `viewFile('${file.path}', '${file.name}')`}">
                <div class="file-icon">
                    <i class="bi ${isFolder ? 'bi-folder-fill' : getFileIcon(file.name)}"></i>
                </div>
                <div class="file-name">${file.name}</div>
                <div class="file-meta">
                    ${isFolder ? 'Папка' : file.size_formatted || ''}
                </div>
                ${!isFolder ? `
                    <div class="file-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewFile('${file.path}', '${file.name}')" title="Просмотр">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('${file.path}', '${file.name}')" title="Скачать">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteFile('${file.path}', '${file.name}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        col.innerHTML = `
            <div class="file-item ${fileClass}" onclick="${isFolder ? `navigateToFolder('${file.path}')` : `viewFile('${file.path}', '${file.name}')`}">
                <div class="file-icon">
                    <i class="bi ${isFolder ? 'bi-folder-fill' : getFileIcon(file.name)}"></i>
                </div>
                <div class="file-info">
                    <div class="file-name">${file.name}</div>
                    <div class="file-meta">${isFolder ? 'Папка' : file.size_formatted || ''}</div>
                </div>
                ${!isFolder ? `
                    <div class="file-actions">
                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewFile('${file.path}', '${file.name}')" title="Просмотр">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="event.stopPropagation(); downloadFile('${file.path}', '${file.name}')" title="Скачать">
                            <i class="bi bi-download"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="event.stopPropagation(); deleteFile('${file.path}', '${file.name}')" title="Удалить">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    return col;
}

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    const iconMap = {
        'pdf': 'bi-file-earmark-pdf',
        'doc': 'bi-file-earmark-word',
        'docx': 'bi-file-earmark-word',
        'xls': 'bi-file-earmark-excel',
        'xlsx': 'bi-file-earmark-excel',
        'ppt': 'bi-file-earmark-ppt',
        'pptx': 'bi-file-earmark-ppt',
        'txt': 'bi-file-earmark-text',
        'jpg': 'bi-file-earmark-image',
        'jpeg': 'bi-file-earmark-image',
        'png': 'bi-file-earmark-image',
        'gif': 'bi-file-earmark-image',
        'mp4': 'bi-file-earmark-play',
        'mp3': 'bi-file-earmark-music',
        'zip': 'bi-file-earmark-zip',
        'rar': 'bi-file-earmark-zip',
        'html': 'bi-file-earmark-code',
        'css': 'bi-file-earmark-code',
        'js': 'bi-file-earmark-code',
        'py': 'bi-file-earmark-code',
        'java': 'bi-file-earmark-code',
        'cpp': 'bi-file-earmark-code',
        'c': 'bi-file-earmark-code',
        'h': 'bi-file-earmark-code'
    };
    return iconMap[ext] || 'bi-file-earmark';
}

function toggleView(view) {
    currentView = view;
    
    // Обновляем кнопки
    document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
    document.getElementById('listViewBtn').classList.toggle('active', view === 'list');
    
    // Перезагружаем файлы с новым видом
    loadFiles();
}

// === ОПЕРАЦИИ С ФАЙЛАМИ ===

function uploadFile() {
    if (!settings || !settings.is_active) {
        showNotification('Сначала настройте подключение к Yandex Disk', 'warning');
        return;
    }
    
    document.getElementById('uploadPath').value = currentPath;
    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
    modal.show();
}

function startUpload() {
    const fileInput = document.getElementById('fileInput');
    const uploadPath = document.getElementById('uploadPath').value;
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('Выберите файл для загрузки', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('path', uploadPath);
    
    const progressBar = document.getElementById('uploadProgress');
    const progressBarFill = progressBar.querySelector('.progress-bar');
    
    progressBar.style.display = 'block';
    
    fetch('/docs/api/yandex/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.display = 'none';
        
        if (data.success) {
            showNotification(data.message, 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
            modal.hide();
            fileInput.value = '';
            loadFiles();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        progressBar.style.display = 'none';
        showNotification('Ошибка при загрузке файла', 'error');
        console.error('Error:', error);
    });
}

function viewFile(path, name) {
    currentFile = { path, name };
    
    document.getElementById('viewModalTitle').innerHTML = `<i class="bi bi-file-earmark"></i> ${name}`;
    
    const viewer = document.getElementById('fileViewer');
    viewer.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Загрузка файла...</p></div>';
    
    const modal = new bootstrap.Modal(document.getElementById('viewModal'));
    modal.show();
    
    // Загружаем содержимое файла
    fetch(`/docs/api/yandex/view?path=${encodeURIComponent(path)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                viewer.innerHTML = `
                    <div class="text-center py-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
                        <h4 class="mt-3 text-muted">Ошибка загрузки</h4>
                        <p class="text-muted">${data.error}</p>
                    </div>
                `;
                return;
            }
            
            renderFileContent(data.content, data.type, name);
        })
        .catch(error => {
            console.error('Error:', error);
            viewer.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle" style="font-size: 4rem; color: #dc3545;"></i>
                    <h4 class="mt-3 text-muted">Ошибка подключения</h4>
                    <p class="text-muted">Не удалось загрузить файл</p>
                </div>
            `;
        });
}

function renderFileContent(content, type, name) {
    const viewer = document.getElementById('fileViewer');
    
    if (type.startsWith('image/')) {
        viewer.innerHTML = `<img src="${content}" class="file-preview" alt="${name}">`;
    } else if (type.startsWith('text/') || name.endsWith('.txt') || name.endsWith('.md')) {
        viewer.innerHTML = `<div class="text-preview">${content}</div>`;
    } else {
        viewer.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-file-earmark" style="font-size: 4rem; color: #6c757d;"></i>
                <h4 class="mt-3 text-muted">Предварительный просмотр недоступен</h4>
                <p class="text-muted">Файл "${name}" не может быть отображен в браузере</p>
                <button class="btn btn-primary" onclick="downloadCurrentFile()">
                    <i class="bi bi-download"></i> Скачать файл
                </button>
            </div>
        `;
    }
}

function downloadCurrentFile() {
    if (currentFile) {
        downloadFile(currentFile.path, currentFile.name);
    }
}

function downloadFile(path, name) {
    const downloadUrl = `/docs/api/yandex/download?path=${encodeURIComponent(path)}`;
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = name;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function deleteFile(path, name) {
    if (!confirm(`Вы уверены, что хотите удалить "${name}"?`)) {
        return;
    }
    
    fetch('/docs/api/yandex/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ path })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            loadFiles();
        } else {
            showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        showNotification('Ошибка удаления файла', 'error');
        console.error('Error:', error);
    });
}

function refreshFiles() {
    loadFiles();
}

// === ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ===

function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'info'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}

// Обработка callback от OAuth
window.addEventListener('message', function(event) {
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'yandex_oauth_success') {
        document.getElementById('accessToken').value = event.data.access_token;
        showNotification('Токен получен успешно!', 'success');
    } else if (event.data.type === 'yandex_oauth_error') {
        showNotification('Ошибка получения токена: ' + event.data.error, 'error');
    }
});
</script>
{% endblock %}