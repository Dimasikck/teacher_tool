{% extends "base.html" %}
{% block title %}Журналы{% endblock %}

{% block content %}
<h1 class="mb-4">Журнал посещаемости и успеваемости</h1>

<div class="row mb-3">
    <div class="col-md-4">
        <select id="groupSelect" class="form-select" onchange="loadJournal()">
            <option value="">Выберите группу</option>
            {% for group in groups %}
            <option value="{{ group.id }}">{{ group.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <input type="month" id="monthSelect" class="form-control mb-2" onchange="loadJournal()" />
        <button class="btn btn-primary" onclick="loadJournal()">Загрузить</button>
        <button class="btn btn-success" onclick="showAddControlPoint()">Добавить КТ</button>
        <button class="btn btn-warning" onclick="syncFromCalendar()">Синхронизировать</button>
        <button class="btn btn-outline-secondary" onclick="showLessonsList()">Список занятий</button>
        <button class="btn btn-info" onclick="exportData()">Экспорт</button>
    </div>
</div>

<div id="journalHeader" class="mb-2"></div>
<div id="attendanceTable"></div>

<div class="row g-3 mt-4" id="groupAnalytics" style="display:none;">
    <div class="col-12 col-md-6">
        <div class="card" style="height: 320px;">
            <div class="card-header"><h6 class="mb-0">Статистика посещаемости</h6></div>
            <div class="card-body"><canvas id="groupAttendanceChart"></canvas></div>
        </div>
    </div>
    <div class="col-12 col-md-6">
        <div class="card" style="height: 320px;">
            <div class="card-header"><h6 class="mb-0">Статистика успеваемости</h6></div>
            <div class="card-body"><canvas id="groupScoresChart"></canvas></div>
        </div>
    </div>
    <div class="col-12 mt-2">
        <small class="text-muted">Диаграммы отражают данные выбранной группы за последние 12 месяцев.</small>
    </div>
</div>

<!-- Модальное окно списка занятий -->
<div class="modal fade" id="lessonsListModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Список занятий</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="lessonsListContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
    </div>

<!-- Модальное окно для добавления контрольной точки -->
<div class="modal fade" id="controlPointModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="controlPointModalTitle">Добавить контрольную точку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Дата</label>
                    <input type="date" id="controlPointDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input type="text" id="controlPointTitle" class="form-control" value="КТ" placeholder="КТ">
                </div>
                <div class="mb-3">
                    <label class="form-label">Максимальный балл</label>
                    <input type="number" id="controlPointMaxPoints" class="form-control" value="100" min="1" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="controlPointSaveBtn" onclick="createControlPoint()">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования контрольной точки -->
<div class="modal fade" id="editControlPointModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать контрольную точку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Дата</label>
                    <input type="date" id="editControlPointDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input type="text" id="editControlPointTitle" class="form-control" placeholder="КТ">
                </div>
                <div class="mb-3">
                    <label class="form-label">Максимальный балл</label>
                    <input type="number" id="editControlPointMaxPoints" class="form-control" min="1" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteControlPointBtn" onclick="deleteControlPoint()">Удалить</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="updateControlPoint()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h3>Статистика посещаемости</h3>
    <div id="statsContainer"></div>
</div>

<script>
let currentLesson = null;

function loadJournal() {
    const groupId = document.getElementById('groupSelect').value;
    const month = document.getElementById('monthSelect').value;
    if (!groupId) {
        alert('Выберите группу');
        return;
    }

    const qs = new URLSearchParams({ group_id: groupId });
    if (month) qs.set('month', month);

    fetch(`/api/journal/group?${qs.toString()}`)
        .then(r => r.json())
        .then(data => {
            renderHeader(data);
            renderJournalTable(data);
            loadGroupAnalytics(groupId);
        });
}

function renderJournalTable(data) {
    const students = data.students;
    const lessons = data.lessons;
    const controlPoints = data.control_points || [];
    const marks = data.marks || {};
    const controlPointMarks = data.control_point_marks || {};

    if (lessons.length === 0 && controlPoints.length === 0) {
        document.getElementById('attendanceTable').innerHTML = '<div class="alert alert-info">Нет занятий и контрольных точек в группе. Создайте первое занятие или контрольную точку.</div>';
        return;
    }

    let html = '<div class="table-responsive">';
    html += '<table class="table table-bordered table-sm align-middle">';
    html += '<thead><tr><th style="min-width:220px">Студент</th>';

    // Добавляем заголовки для занятий
    lessons.forEach(lesson => {
        const dateStr = new Date(lesson.date).toLocaleDateString('ru-RU');
        html += `<th class="text-center">
                    <button class="btn btn-link p-0" onclick="openLessonModal(${lesson.id}, '${dateStr}')" title="Открыть детали занятия">
                        ${dateStr}
                    </button>
                 </th>`;
    });

    // Добавляем заголовки для контрольных точек
    controlPoints.forEach(cp => {
        const dateStr = new Date(cp.date).toLocaleDateString('ru-RU');
        html += `<th class="text-center bg-warning bg-opacity-25">
                    <button class="btn btn-link p-0" onclick="openControlPointModal(${cp.id}, '${dateStr}', '${cp.title}', ${cp.max_points})" title="Редактировать контрольную точку">
                        ${dateStr}<br><small>${cp.title}</small>
                    </button>
                 </th>`;
    });
    html += '</tr></thead><tbody>';

     students.forEach(st => {
         html += `<tr><td>${st.name}</td>`;
         
         // Ячейки для занятий
         lessons.forEach(lesson => {
             const key = `${st.id}:${lesson.id}`;
             const cell = marks[key] || {present: null, mark: ''};
             // Если present === null, то ячейка пустая (новое занятие)
             // Если present === false, то студент отсутствовал (Н)
             // Если present === true, то студент присутствовал (оценка или пусто)
             let value = '';
             if (cell.present === false) {
                 value = 'Н';
             } else if (cell.present === true) {
                 value = cell.mark || '';
             }
             // Если present === null, value остается пустым
             
             const cellClass = getCellClass(value);
             html += `<td class="p-0">
                         <input 
                             class="form-control form-control-sm border-0 text-center journal-input ${cellClass}"
                             style="min-width:70px; font-weight: ${value ? 'bold' : 'normal'};"
                             data-student="${st.id}"
                             data-lesson="${lesson.id}"
                             value="${value}"
                             maxlength="5"
                             onclick="showCellTooltip(this)"
                             onchange="saveCell(this)"
                             onblur="hideCellTooltip(this)"
                         />
                      </td>`;
         });

         // Ячейки для контрольных точек
         controlPoints.forEach(cp => {
             const key = `${st.id}:${cp.id}`;
             const cell = controlPointMarks[key] || {points: null};
             const value = cell.points !== null ? cell.points : '';
             
             html += `<td class="p-0 bg-warning bg-opacity-10">
                         <input 
                             class="form-control form-control-sm border-0 text-center control-point-input"
                             style="min-width:70px; font-weight: ${value ? 'bold' : 'normal'};"
                             data-student="${st.id}"
                             data-control-point="${cp.id}"
                             data-max-points="${cp.max_points}"
                             value="${value}"
                             type="number"
                             min="0"
                             max="${cp.max_points}"
                             placeholder="0-${cp.max_points}"
                             onchange="saveControlPointScore(this)"
                         />
                      </td>`;
         });
         
         html += '</tr>';
     });

    html += '</tbody></table></div>';

    document.getElementById('attendanceTable').innerHTML = html;
}

let groupAttendanceChart = null;
let groupScoresChart = null;

function loadGroupAnalytics(groupId) {
    document.getElementById('groupAnalytics').style.display = 'block';

    // Посещаемость
    fetch(`/api/analytics/attendance-monthly/group?group_id=${groupId}`)
        .then(r => r.json())
        .then(monthly => {
            const ctx = document.getElementById('groupAttendanceChart');
            if (groupAttendanceChart) groupAttendanceChart.destroy();
            groupAttendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthly.labels,
                    datasets: [
                        { label: 'Присутствовали', data: monthly.present, backgroundColor: '#28a745' },
                        { label: 'Отсутствовали', data: monthly.absent, backgroundColor: '#dc3545' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } },
                        y: { stacked: true, beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } }
                    }
                }
            });
        });

    // Успеваемость: столбчатая диаграмма с накоплением по категориям
    fetch(`/api/analytics/scores-monthly/group?group_id=${groupId}`)
        .then(r => r.json())
        .then(series => {
            const ctx2 = document.getElementById('groupScoresChart');
            if (groupScoresChart) groupScoresChart.destroy();
            groupScoresChart = new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: series.labels,
                    datasets: [
                        { label: 'Отлично (90-100)', data: series.excellent, backgroundColor: '#198754' },
                        { label: 'Хорошо (75-89)', data: series.good, backgroundColor: '#0d6efd' },
                        { label: 'Удовл. (60-74)', data: series.average, backgroundColor: '#ffc107' },
                        { label: 'Низко (<60)', data: series.low, backgroundColor: '#dc3545' },
                        { label: 'Без оценки', data: series.no_score, backgroundColor: '#6c757d' }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } },
                        y: { stacked: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } }
                    }
                }
            });
        });
}

function renderHeader(data) {
    const group = data.group || {};
    const subject = group.subject || group.course || '';
    const course = subject ? `, дисциплина: <strong>${subject}</strong>` : '';
    const form = group.education_form ? `, форма: ${group.education_form}` : '';
    const dateInfo = document.getElementById('monthSelect').value ? `, месяц: ${document.getElementById('monthSelect').value}` : '';
    const stats = data.stats || {};
    const counts = (stats.month_lessons != null && stats.total_lessons != null)
        ? `, занятия: <strong>${stats.month_lessons}</strong> за месяц / <strong>${stats.total_lessons}</strong> всего`
        : '';
    document.getElementById('journalHeader').innerHTML = `
        <div class="alert alert-secondary py-2">
            Группа: <strong>${group.name || ''}</strong>${course}${form}${dateInfo}${counts}
        </div>
    `;
}

function getCellClass(value) {
    if (!value) return '';
    switch(value.toString().trim()) {
        case '5': return 'text-success';
        case '4': return 'text-primary';
        case '3': return 'text-warning';
        case 'Н': case 'н': case 'Н.': case 'н.': return 'text-danger';
        default: return '';
    }
}

function showCellTooltip(inputEl) {
    if (inputEl.value.trim() === '') {
        // Показываем подсказку только для пустых ячеек
        const tooltip = document.createElement('div');
        tooltip.className = 'cell-tooltip';
        tooltip.innerHTML = '5/4/3/Н';
        tooltip.style.cssText = `
            position: absolute;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        // Позиционируем подсказку
        const rect = inputEl.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 - 35) + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';
        
        document.body.appendChild(tooltip);
        inputEl.dataset.tooltip = 'true';
        
        // Убираем подсказку через 2.5 секунды
        setTimeout(() => {
            if (tooltip.parentNode) {
                tooltip.parentNode.removeChild(tooltip);
            }
        }, 2500);
    }
}

function hideCellTooltip(inputEl) {
    const tooltips = document.querySelectorAll('.cell-tooltip');
    tooltips.forEach(tooltip => {
        if (tooltip.parentNode) {
            tooltip.parentNode.removeChild(tooltip);
        }
    });
}

function saveCell(inputEl) {
    const studentId = parseInt(inputEl.dataset.student);
    const lessonId = parseInt(inputEl.dataset.lesson);
    const raw = (inputEl.value || '').trim();

    fetch('/api/journal/mark', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ student_id: studentId, lesson_id: lessonId, value: raw })
    })
    .then(r => r.json())
    .then(res => {
        if (res.error) {
            alert('Ошибка: ' + res.error);
            return;
        }
        
        // Обновляем отображение ячейки
        let value = '';
        if (res.present === false) {
            value = 'Н';
        } else if (res.present === true) {
            value = res.mark || '';
        }
        // Если res.present === null, value остается пустым
        
        inputEl.value = value;
        
        // Обновляем стили
        const cellClass = getCellClass(value);
        inputEl.className = `form-control form-control-sm border-0 text-center journal-input ${cellClass}`;
        inputEl.style.fontWeight = value ? 'bold' : 'normal';
    })
    .catch(err => {
        console.error(err);
        alert('Не удалось сохранить значение');
    });
}

function showAddLesson() {
    new bootstrap.Modal(document.getElementById('lessonModal')).show();
}

function createLesson() {
    const groupId = document.getElementById('groupSelect').value;
    const date = document.getElementById('lessonDate').value;
    const topic = document.getElementById('lessonTopic').value;
    const notes = document.getElementById('lessonNotes').value;

    fetch('/api/lessons', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            group_id: groupId,
            date: date + 'T09:00:00',
            topic: topic,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
        loadJournal();
    });
}

function openLessonModal(lessonId, dateStr) {
    fetch(`/api/lesson/${lessonId}`)
        .then(r => r.json())
        .then(lesson => {
            document.getElementById('lessonModalTitle').textContent = `Занятие ${dateStr}`;
            document.getElementById('lessonTopic').value = lesson.topic || '';
            document.getElementById('lessonNotes').value = lesson.notes || '';
            const saveBtn = document.getElementById('lessonSaveBtn');
            saveBtn.textContent = 'Сохранить';
            saveBtn.onclick = function() { updateLesson(lesson.id); };
            new bootstrap.Modal(document.getElementById('lessonModal')).show();
        });
}

function updateLesson(lessonId) {
    const topic = document.getElementById('lessonTopic').value;
    const notes = document.getElementById('lessonNotes').value;
    fetch('/api/lessons', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            // Для простоты переиспользуем создание: если нужна явная правка — в бэкенде можно добавить PUT
            // Здесь оставим только фронтовое сохранение через отдельный эндпоинт при расширении
        })
    });
    // Пока просто закрываем окно и не меняем дату
    bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
}

function showLessonsList() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) { alert('Выберите группу'); return; }
    fetch(`/api/lessons?group_id=${groupId}`)
        .then(r => r.json())
        .then(allLessons => {
            const month = document.getElementById('monthSelect').value;
            let lessons = allLessons;
            if (month) {
                lessons = allLessons.filter(l => l.date.startsWith(month));
            }

            if (lessons.length === 0) {
                document.getElementById('lessonsListContainer').innerHTML = '<div class="alert alert-info">Занятия не найдены</div>';
                new bootstrap.Modal(document.getElementById('lessonsListModal')).show();
                return;
            }

            let html = '<div class="list-group">';
            lessons.sort((a,b) => new Date(a.date) - new Date(b.date));
            lessons.forEach(l => {
                const d = new Date(l.date);
                const dateStr = d.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' });
                const topic = (l.topic || '').trim() || '(без темы)';
                const notes = (l.notes || '').trim();
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${dateStr}</h6>
                        </div>
                        <p class="mb-1"><strong>Тема:</strong> ${escapeHtml(topic)}</p>
                        ${notes ? `<small class="text-muted"><strong>Заметки:</strong> ${escapeHtml(notes)}</small>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('lessonsListContainer').innerHTML = html;
            new bootstrap.Modal(document.getElementById('lessonsListModal')).show();
        });
}

function escapeHtml(str) {
    return String(str).replace(/[&<>"]/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]);
    });
}

function loadStats() {
    const groupId = document.getElementById('groupSelect').value;

    fetch(`/api/attendance/stats?group_id=${groupId}`)
        .then(r => r.json())
        .then(stats => {
            let html = '<table class="table"><thead><tr><th>Студент</th><th>Посещаемость</th></tr></thead><tbody>';
            stats.forEach(s => {
                html += `<tr><td>${s.student}</td><td>${s.percentage}% (${s.present}/${s.total})</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('statsContainer').innerHTML = html;
        });
}

function exportData() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) return;

    fetch(`/export/attendance/${groupId}`)
        .then(r => r.json())
        .then(data => {
            window.open(data.file, '_blank');
        });
}

function syncFromCalendar() {
    if (!confirm('Синхронизировать занятия из календаря в журнал? Это добавит новые занятия и обновит существующие.')) {
        return;
    }
    
    // Показываем индикатор загрузки
    const syncBtn = event.target;
    const originalText = syncBtn.innerHTML;
    syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Синхронизация...';
    syncBtn.disabled = true;
    
    fetch('/api/schedule/sync-to-journal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`Синхронизация завершена!\nСоздано занятий: ${data.created}\nОбновлено занятий: ${data.updated}`);
            // Перезагружаем журнал
            loadJournal();
        } else {
            alert('Ошибка синхронизации: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка синхронизации: ' + error.message);
    })
    .finally(() => {
        // Восстанавливаем кнопку
        syncBtn.innerHTML = originalText;
        syncBtn.disabled = false;
    });
}

// Функции для работы с контрольными точками
let currentControlPointId = null;

function showAddControlPoint() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) {
        alert('Выберите группу');
        return;
    }
    
    // Очищаем форму
    document.getElementById('controlPointDate').value = '';
    document.getElementById('controlPointTitle').value = 'КТ';
    document.getElementById('controlPointMaxPoints').value = '100';
    
    new bootstrap.Modal(document.getElementById('controlPointModal')).show();
}

function createControlPoint() {
    const groupId = document.getElementById('groupSelect').value;
    const date = document.getElementById('controlPointDate').value;
    const title = document.getElementById('controlPointTitle').value;
    const maxPoints = parseInt(document.getElementById('controlPointMaxPoints').value);

    if (!date) {
        alert('Укажите дату');
        return;
    }

    const data = {
        group_id: parseInt(groupId),
        date: date,
        title: title || 'КТ',
        max_points: maxPoints || 100
    };

    fetch('/api/control-point/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('controlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при создании контрольной точки: ' + error.message);
    });
}

function openControlPointModal(controlPointId, dateStr, title, maxPoints) {
    currentControlPointId = controlPointId;
    
    document.getElementById('editControlPointDate').value = dateStr.split('.').reverse().join('-');
    document.getElementById('editControlPointTitle').value = title;
    document.getElementById('editControlPointMaxPoints').value = maxPoints;
    
    new bootstrap.Modal(document.getElementById('editControlPointModal')).show();
}

function updateControlPoint() {
    if (!currentControlPointId) return;
    
    const date = document.getElementById('editControlPointDate').value;
    const title = document.getElementById('editControlPointTitle').value;
    const maxPoints = parseInt(document.getElementById('editControlPointMaxPoints').value);

    const data = {
        date: date,
        title: title,
        max_points: maxPoints
    };

    fetch(`/api/control-point/${currentControlPointId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editControlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении контрольной точки: ' + error.message);
    });
}

function deleteControlPoint() {
    if (!currentControlPointId) return;
    
    if (!confirm('Вы уверены, что хотите удалить эту контрольную точку? Все оценки будут удалены.')) {
        return;
    }

    fetch(`/api/control-point/${currentControlPointId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editControlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении контрольной точки: ' + error.message);
    });
}

function saveControlPointScore(inputEl) {
    const studentId = inputEl.dataset.student;
    const controlPointId = inputEl.dataset.controlPoint;
    const maxPoints = parseInt(inputEl.dataset.maxPoints);
    let points = inputEl.value.trim();

    // Валидация
    if (points === '') {
        points = null;
    } else {
        points = parseInt(points);
        if (isNaN(points) || points < 0 || points > maxPoints) {
            alert(`Баллы должны быть от 0 до ${maxPoints}`);
            inputEl.focus();
            return;
        }
    }

    const data = {
        control_point_id: parseInt(controlPointId),
        student_id: parseInt(studentId),
        points: points
    };

    fetch('/api/control-point/score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Обновляем стили
            inputEl.style.fontWeight = points !== null ? 'bold' : 'normal';
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении оценки: ' + error.message);
    });
}
</script>

<style>
/* Стили для ячеек журнала */
.journal-input {
    transition: all 0.2s ease;
    background: transparent !important;
    color: var(--text-primary) !important;
}

.journal-input:hover {
    background: rgba(0, 123, 255, 0.1) !important;
    border: 1px solid rgba(0, 123, 255, 0.3) !important;
}

.journal-input:focus {
    background: rgba(0, 123, 255, 0.15) !important;
    border: 1px solid #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

/* Цвета для оценок - адаптивные под темы */
.journal-input.text-success {
    color: #198754 !important;
}

.journal-input.text-primary {
    color: #0d6efd !important;
}

.journal-input.text-warning {
    color: #fd7e14 !important;
}

/* Специальная обработка для Н - серые оттенки */
.journal-input.text-danger {
    color: #6c757d !important; /* Темно-серый для светлой темы */
}

/* Темная тема - переопределение цветов */
[data-theme="dark"] .journal-input.text-success {
    color: #20c997 !important;
}

[data-theme="dark"] .journal-input.text-primary {
    color: #6ea8fe !important;
}

[data-theme="dark"] .journal-input.text-warning {
    color: #ffc107 !important;
}

[data-theme="dark"] .journal-input.text-danger {
    color: #adb5bd !important; /* Светло-серый для темной темы */
}

/* Стили для таблицы - адаптивные под темы */
.table-bordered th,
.table-bordered td {
    border: 1px solid var(--border-color) !important;
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
}

.table th {
    background-color: var(--table-header-bg) !important;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    color: var(--text-primary) !important;
}

.table tbody tr:hover {
    background-color: var(--table-hover-bg) !important;
}

/* Стили для заголовков дат */
.table th button {
    color: var(--text-primary) !important;
    text-decoration: none;
}

.table th button:hover {
    color: #007bff !important;
    text-decoration: underline;
}

/* Адаптивность */
@media (max-width: 768px) {
    .journal-input {
        min-width: 50px !important;
        font-size: 0.8rem;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
}

/* Анимация для подсказок */
.cell-tooltip {
    animation: fadeIn 0.3s ease-in-out;
    background: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Дополнительные стили для лучшей интеграции с темами */
.table-responsive {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    overflow-x: auto; /* включаем горизонтальную прокрутку */
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* плавная прокрутка на мобильных */
    position: relative; /* для корректных контекстов наложения */
    box-shadow: 0 2px 10px var(--shadow-light);
}

.table {
    margin-bottom: 0;
    position: relative; /* повышаем контекст наложения для sticky */
    border-collapse: separate !important; /* sticky корректно работает с separate */
    border-spacing: 0; /* сохраняем внешний вид рамок */
}

/* Не переносим содержимое ячеек, чтобы появлялся горизонтальный скролл */
.table thead th,
.table tbody td {
    white-space: nowrap;
}

/* Первую колонку (студент) можно переносить для читабельности */
.table thead th:first-child,
.table tbody td:first-child {
    white-space: normal;
}

/* Закрепляем первый столбец при горизонтальной прокрутке */
.table thead th:first-child,
.table tbody td:first-child {
    position: -webkit-sticky;
    position: sticky;
    left: 0;
    z-index: 2; /* выше остальных ячеек */
}

/* Заголовок первого столбца поверх данных и с корректным фоном */
.table thead th:first-child {
    z-index: 3;
    background-color: var(--table-header-bg) !important;
    min-width: 220px;
}

/* Тело первого столбца: фон и визуальное разделение */
.table tbody td:first-child {
    background-color: var(--bg-secondary) !important;
    box-shadow: 2px 0 0 0 var(--border-color);
    min-width: 220px;
}

/* Стили для ячеек с данными */
.table td {
    padding: 0.5rem;
    vertical-align: middle;
}

/* Улучшенные стили для input полей в ячейках */
.journal-input {
    border: 1px solid transparent !important;
    border-radius: 4px;
}

.journal-input:not(:focus):not(:hover) {
    border-color: transparent !important;
}

/* Стили для пустых ячеек */
.journal-input:placeholder-shown {
    color: var(--text-secondary) !important;
    font-style: italic;
}

/* Стили для заполненных ячеек */
.journal-input:not(:placeholder-shown) {
    font-weight: bold;
}

/* Стили для контрольных точек */
.control-point-input {
    transition: all 0.2s ease;
    background: transparent !important;
    color: var(--text-primary) !important;
    border: 1px solid transparent !important;
    border-radius: 4px;
}

.control-point-input:hover {
    background: rgba(255, 193, 7, 0.1) !important;
    border: 1px solid rgba(255, 193, 7, 0.3) !important;
}

.control-point-input:focus {
    background: rgba(255, 193, 7, 0.15) !important;
    border: 1px solid #ffc107 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
}

.control-point-input:not(:focus):not(:hover) {
    border-color: transparent !important;
}

/* Стили для заголовков контрольных точек */
.bg-warning.bg-opacity-25 {
    background-color: rgba(255, 193, 7, 0.25) !important;
}

.bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

/* Адаптация для темной темы */
[data-theme="dark"] .bg-warning.bg-opacity-25 {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

[data-theme="dark"] .bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.05) !important;
}
</style>
{% endblock %}