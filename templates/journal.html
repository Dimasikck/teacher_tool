{% extends "base.html" %}
{% block title %}Журналы{% endblock %}

{% block extra_css %}
<style>
    /* Кнопки действий журнала: стиль как на календаре */
    .journal-actions { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        margin-bottom: 20px;
    }
    .journal-actions .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        line-height: 1.2;
        border-radius: 8px;
        padding: 0.45rem 0.75rem;
        white-space: normal; /* разрешаем перенос */
        flex: 1 1 170px; /* каждая кнопка растягивается, но минимум ~170px */
        justify-content: center;
        text-align: center;
    }
    .journal-actions .btn i { flex: 0 0 auto; }
    .journal-actions .btn span {
        white-space: normal; /* разрешаем перенос строк внутри подписи */
    }
    /* Темная тема: делаем селект дисциплины темно-серым, когда он disabled */
    [data-theme="dark"] #subjectSelect:disabled {
        background-color: #2d3748 !important; /* темно-серый */
        color: var(--text-muted) !important;
        border-color: var(--border-color) !important;
        opacity: 1 !important; /* отменяем обесцвечивание bootstrap */
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Журнал посещаемости и успеваемости</h1>

<div class="row mb-3">
    <div class="col-md-4">
        <select id="groupSelect" class="form-select" onchange="onGroupChange()">
            <option value="">Выберите группу</option>
            {% for group in groups %}
            <option value="{{ group.id }}" data-name="{{ group.name }}" data-course="{{ group.course or '' }}" data-form="{{ group.education_form or '' }}">{{ group.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <select id="subjectSelect" class="form-select" onchange="loadJournal()" disabled>
            <option value="">Выберите дисциплину</option>
        </select>
    </div>
    <div class="col-md-4">
        <input type="month" id="monthSelect" class="form-control" onchange="loadJournal()" />
    </div>
</div>

<div class="journal-actions" role="group">
    <button class="btn btn-primary" onclick="loadJournal()">
        <i class="bi bi-arrow-clockwise"></i> <span>Загрузить</span>
    </button>
    <button class="btn btn-success" onclick="showAddControlPoint()">
        <i class="bi bi-plus-circle"></i> <span>Добавить КТ</span>
    </button>
    <button class="btn btn-warning" onclick="syncFromCalendar()">
        <i class="bi bi-arrow-repeat"></i> <span>Синхронизировать</span>
    </button>
    <button class="btn btn-outline-secondary" onclick="showLessonsList()">
        <i class="bi bi-list-ul"></i> <span>Список занятий</span>
    </button>
    <button class="btn btn-info" onclick="exportData()">
        <i class="bi bi-download"></i> <span>Экспорт</span>
    </button>
</div>

<div id="journalHeader" class="mb-2"></div>
<div id="attendanceTable"></div>


<!-- Модальное окно списка занятий -->
<div class="modal fade" id="lessonsListModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Список занятий</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="lessonsListContainer"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
    </div>

<!-- Модальное окно редактирования занятия -->
<div class="modal fade" id="editLessonModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать занятие</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editLessonId">
                <div class="mb-3">
                    <label class="form-label">Тема занятия</label>
                    <input type="text" id="editLessonTopic" class="form-control" placeholder="Введите тему занятия">
                </div>
                <div class="mb-3">
                    <label class="form-label">Заметки</label>
                    <textarea id="editLessonNotes" class="form-control" rows="4" placeholder="Добавьте заметки"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveLessonEdits()">Сохранить</button>
            </div>
        </div>
    </div>
    </div>

<!-- Модальное окно для добавления контрольной точки -->
<div class="modal fade" id="controlPointModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="controlPointModalTitle">Добавить контрольную точку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Дата</label>
                    <input type="date" id="controlPointDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input type="text" id="controlPointTitle" class="form-control" value="КТ" placeholder="КТ">
                </div>
                <div class="mb-3">
                    <label class="form-label">Максимальный балл</label>
                    <input type="number" id="controlPointMaxPoints" class="form-control" value="100" min="1" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="controlPointSaveBtn" onclick="createControlPoint()">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для редактирования контрольной точки -->
<div class="modal fade" id="editControlPointModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать контрольную точку</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Дата</label>
                    <input type="date" id="editControlPointDate" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Название</label>
                    <input type="text" id="editControlPointTitle" class="form-control" placeholder="КТ">
                </div>
                <div class="mb-3">
                    <label class="form-label">Максимальный балл</label>
                    <input type="number" id="editControlPointMaxPoints" class="form-control" min="1" max="1000">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteControlPointBtn" onclick="deleteControlPoint()">Удалить</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="updateControlPoint()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<div class="mt-4">
    <h3>Статистика посещаемости и успеваемости группы</h3>
    <div id="statsContainer"></div>
    <div class="row row-cols-1 row-cols-sm-2 g-3 mt-4" id="groupAnalytics" style="display:none;">
        <div class="col">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Статистика посещаемости</h5>
                </div>
                <div class="card-body">
                    <canvas id="groupAttendanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">Статистика успеваемости</h5>
                </div>
                <div class="card-body">
                    <canvas id="groupScoresChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12 mt-2">
            <small class="text-muted">Диаграммы отражают данные выбранной группы за последние 12 месяцев.</small>
        </div>
    </div>
</div>

<script>
let currentLesson = null;

function calculateStudentSummary(studentId, controlPoints, controlPointMarks) {
    if (!controlPoints || controlPoints.length === 0) {
        return {
            average: '-',
            grade: 'Нет КТ',
            color: '#6c757d'
        };
    }
    
    let totalPoints = 0;
    let totalMaxPoints = 0;
    let hasScores = false;
    
    // Проходим по всем контрольным точкам
    controlPoints.forEach(cp => {
        const key = `${studentId}:${cp.id}`;
        const cell = controlPointMarks[key];
        
        if (cell && cell.points !== null && cell.points !== undefined) {
            // Нормализуем баллы к 100-балльной шкале
            const normalizedScore = (cell.points / cp.max_points) * 100;
            totalPoints += normalizedScore;
            totalMaxPoints += 100;
            hasScores = true;
        }
    });
    
    if (!hasScores) {
        return {
            average: '-',
            grade: 'Нет оценок',
            color: '#6c757d'
        };
    }
    
    // Вычисляем среднее арифметическое
    const average = totalPoints / (totalMaxPoints / 100);
    const roundedAverage = Math.round(average * 10) / 10; // Округляем до 1 знака после запятой
    
    // Определяем оценку и цвет
    let grade, color;
    if (average >= 85) {
        grade = 'Отлично';
        color = '#198754'; // Зеленый
    } else if (average >= 70) {
        grade = 'Хорошо';
        color = '#0d6efd'; // Синий
    } else if (average >= 55) {
        grade = 'Удовлетворительно';
        color = '#ffc107'; // Желтый
    } else {
        grade = 'Неудовлетворительно';
        color = '#dc3545'; // Красный
    }
    
    return {
        average: roundedAverage,
        grade: grade,
        color: color
    };
}

function onGroupChange() {
    const groupId = document.getElementById('groupSelect').value;
    const subjectSelect = document.getElementById('subjectSelect');
    subjectSelect.innerHTML = '<option value="">Загрузка дисциплин...</option>';
    subjectSelect.disabled = true;
    if (!groupId) {
        subjectSelect.innerHTML = '<option value="">Выберите дисциплину</option>';
        document.getElementById('attendanceTable').innerHTML = '';
        document.getElementById('journalHeader').innerHTML = '';
        return;
    }
    fetch(`/api/group/subjects?group_id=${groupId}`)
        .then(r => r.json())
        .then(subjects => {
            let options = '<option value="">Выберите дисциплину</option>';
            subjects.forEach(s => { options += `<option value="${s}">${s}</option>`; });
            subjectSelect.innerHTML = options;
            subjectSelect.disabled = false;
        })
        .catch(() => {
            subjectSelect.innerHTML = '<option value="">Выберите дисциплину</option>';
            subjectSelect.disabled = false;
        });
}

function loadJournal() {
    const groupSelect = document.getElementById('groupSelect');
    const groupId = groupSelect.value;
    const subject = document.getElementById('subjectSelect').value;
    const month = document.getElementById('monthSelect').value;
    if (!groupId) {
        alert('Выберите группу');
        return;
    }
    if (!subject) {
        alert('Выберите дисциплину');
        return;
    }

    // Немедленно отображаем базовый заголовок
    const selectedOption = groupSelect.options[groupSelect.selectedIndex];
    if (selectedOption && selectedOption.value) {
        const groupName = selectedOption.getAttribute('data-name') || selectedOption.text;
        const course = selectedOption.getAttribute('data-course') || '';
        const form = selectedOption.getAttribute('data-form') || '';
        const courseInfo = course ? `, дисциплина: <strong>${course}</strong>` : '';
        const formInfo = form ? `, форма: ${form}` : '';
        const dateInfo = month ? `, месяц: ${month}` : '';
        
        document.getElementById('journalHeader').innerHTML = `
            <div class="alert alert-secondary py-2">
                Группа: <strong>${groupName}</strong>${courseInfo}${formInfo}${dateInfo} <span class="text-muted">(загрузка...)</span>
            </div>
        `;
    }

    const qs = new URLSearchParams({ group_id: groupId });
    if (subject) qs.set('subject', subject);
    if (month) qs.set('month', month);

    fetch(`/api/journal/group?${qs.toString()}`)
        .then(r => r.json())
        .then(data => {
            renderHeader(data);
            renderJournalTable(data);
            loadGroupAnalytics(groupId);
        })
        .catch(error => {
            console.error('Ошибка загрузки журнала:', error);
            // Сохраняем заголовок даже при ошибке
            const groupSelect = document.getElementById('groupSelect');
            const selectedOption = groupSelect.options[groupSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                document.getElementById('journalHeader').innerHTML = `
                    <div class="alert alert-warning py-2">
                        Группа: <strong>${selectedOption.text}</strong> - Ошибка загрузки данных
                    </div>
                `;
            }
            document.getElementById('attendanceTable').innerHTML = '<div class="alert alert-danger">Ошибка загрузки данных журнала. Попробуйте обновить страницу.</div>';
        });
}

function renderJournalTable(data) {
    const students = data.students;
    const lessons = data.lessons;
    const controlPoints = data.control_points || [];
    const marks = data.marks || {};
    const controlPointMarks = data.control_point_marks || {};

    if (lessons.length === 0 && controlPoints.length === 0) {
        document.getElementById('attendanceTable').innerHTML = '<div class="alert alert-info">Нет занятий и контрольных точек в группе. Создайте первое занятие или контрольную точку.</div>';
        // Заголовок должен отображаться даже если нет данных
        return;
    }

    // Объединяем занятия и контрольные точки и сортируем по дате
    const allColumns = [];
    
    // Добавляем занятия
    lessons.forEach(lesson => {
        allColumns.push({
            type: 'lesson',
            date: new Date(lesson.date),
            data: lesson
        });
    });
    
    // Добавляем контрольные точки
    controlPoints.forEach(cp => {
        allColumns.push({
            type: 'control_point',
            date: new Date(cp.date),
            data: cp
        });
    });
    
    // Сортируем по дате
    allColumns.sort((a, b) => a.date - b.date);

    let html = '<div class="table-responsive">';
    html += '<table class="table table-bordered table-sm align-middle">';
    html += '<thead><tr><th style="min-width:220px">Студент</th>';

    // Добавляем заголовки в хронологическом порядке
    allColumns.forEach(column => {
        const dateStr = column.date.toLocaleDateString('ru-RU');
        
        if (column.type === 'lesson') {
            const lesson = column.data;
            html += `<th class="text-center">
                        <button class="btn btn-link p-0" onclick="openLessonModal(${lesson.id}, '${dateStr}')" title="Открыть детали занятия">
                            ${dateStr}
                        </button>
                     </th>`;
        } else if (column.type === 'control_point') {
            const cp = column.data;
            html += `<th class="text-center bg-warning bg-opacity-25">
                        <button class="btn btn-link p-0" onclick="openControlPointModal(${cp.id}, '${dateStr}', '${cp.title}', ${cp.max_points})" title="Редактировать контрольную точку">
                            ${dateStr}<br><small>${cp.title}</small>
                        </button>
                     </th>`;
        }
    });
    
    // Добавляем столбец "Итог"
    html += '<th class="text-center bg-info bg-opacity-25" style="min-width:120px;">Итог</th>';
    html += '</tr></thead><tbody>';

     students.forEach(st => {
         html += `<tr><td>${st.name}</td>`;
         
         // Ячейки в хронологическом порядке
         allColumns.forEach(column => {
             if (column.type === 'lesson') {
                 const lesson = column.data;
                 const key = `${st.id}:${lesson.id}`;
                 const cell = marks[key] || {present: null, mark: ''};
                 // Если present === null, то ячейка пустая (новое занятие)
                 // Если present === false, то студент отсутствовал (Н)
                 // Если present === true, то студент присутствовал (оценка или пусто)
                 let value = '';
                 if (cell.present === false) {
                     value = 'Н';
                 } else if (cell.present === true) {
                     value = cell.mark || '';
                 }
                 // Если present === null, value остается пустым
                 
                 const cellClass = getCellClass(value);
                 html += `<td class="p-0">
                             <input 
                                 class="form-control form-control-sm border-0 text-center journal-input ${cellClass}"
                                 style="min-width:70px; font-weight: ${value ? 'bold' : 'normal'};"
                                 data-student="${st.id}"
                                 data-lesson="${lesson.id}"
                                 value="${value}"
                                 maxlength="5"
                                 onclick="showCellTooltip(this)"
                                 onchange="saveCell(this)"
                                 onblur="hideCellTooltip(this)"
                             />
                          </td>`;
             } else if (column.type === 'control_point') {
                 const cp = column.data;
                 const key = `${st.id}:${cp.id}`;
                 const cell = controlPointMarks[key] || {points: null};
                 const value = cell.points !== null ? cell.points : '';
                 
                 html += `<td class="p-0 bg-warning bg-opacity-10">
                             <input 
                                 class="form-control form-control-sm border-0 text-center control-point-input"
                                 style="min-width:70px; font-weight: ${value ? 'bold' : 'normal'};"
                                 data-student="${st.id}"
                                 data-control-point="${cp.id}"
                                 data-max-points="${cp.max_points}"
                                 value="${value}"
                                 type="number"
                                 min="0"
                                 max="${cp.max_points}"
                                 placeholder="0-${cp.max_points}"
                                 onchange="saveControlPointScore(this)"
                             />
                          </td>`;
             }
         });
         
         // Добавляем ячейку "Итог"
         const summaryResult = calculateStudentSummary(st.id, controlPoints, controlPointMarks);
         html += `<td class="text-center bg-info bg-opacity-10 summary-cell">
                     <div class="summary-average">${summaryResult.average}</div>
                     <div class="summary-grade" style="color: ${summaryResult.color};">${summaryResult.grade}</div>
                  </td>`;
         
         html += '</tr>';
     });

    html += '</tbody></table></div>';

    document.getElementById('attendanceTable').innerHTML = html;

    // Подключаем подсветку строк и столбцов после рендера
    attachHighlightHandlers();
}

let groupAttendanceChart = null;
let groupScoresChart = null;

function loadGroupAnalytics(groupId) {
    document.getElementById('groupAnalytics').style.display = 'block';

    // Посещаемость
    fetch(`/api/analytics/attendance-monthly/group?group_id=${groupId}`)
        .then(r => r.json())
        .then(monthly => {
            const ctx = document.getElementById('groupAttendanceChart');
            if (groupAttendanceChart) groupAttendanceChart.destroy();
            groupAttendanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthly.labels,
                    datasets: [
                        { label: 'Присутствовали', data: monthly.present, backgroundColor: '#28a745' },
                        { label: 'Отсутствовали', data: monthly.absent, backgroundColor: '#dc3545' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } },
                        y: { stacked: true, beginAtZero: true, ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') } }
                    }
                }
            });
        });

    // Успеваемость: линейчатая диаграмма с накоплением по контрольным точкам
    fetch(`/api/analytics/control-points/group?group_id=${groupId}`)
        .then(r => r.json())
        .then(data => {
            const ctx2 = document.getElementById('groupScoresChart');
            if (groupScoresChart) groupScoresChart.destroy();
            
            if (data.labels && data.labels.length > 0) {
                groupScoresChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            { 
                                label: 'Отлично (90-100%)', 
                                data: data.excellent, 
                                backgroundColor: '#198754',
                                borderColor: '#198754',
                                borderWidth: 1
                            },
                            { 
                                label: 'Хорошо (75-89%)', 
                                data: data.good, 
                                backgroundColor: '#0d6efd',
                                borderColor: '#0d6efd',
                                borderWidth: 1
                            },
                            { 
                                label: 'Удовл. (60-74%)', 
                                data: data.average, 
                                backgroundColor: '#ffc107',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            },
                            { 
                                label: 'Низко (<60%)', 
                                data: data.low, 
                                backgroundColor: '#dc3545',
                                borderColor: '#dc3545',
                                borderWidth: 1
                            },
                            { 
                                label: 'Без оценки', 
                                data: data.no_score, 
                                backgroundColor: '#6c757d',
                                borderColor: '#6c757d',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { 
                                position: 'top',
                                labels: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: { 
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.x;
                                        return `${label}: ${value} студ.`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                stacked: true,
                                beginAtZero: true,
                                ticks: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                    stepSize: 1
                                }, 
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Количество студентов',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            y: { 
                                stacked: true,
                                ticks: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                    maxTicksLimit: 10
                                }, 
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Контрольные точки',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
            } else {
                // Если нет данных, показываем сообщение
                ctx2.getContext('2d').clearRect(0, 0, ctx2.width, ctx2.height);
                const ctx = ctx2.getContext('2d');
                ctx.font = '16px Arial';
                ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
                ctx.textAlign = 'center';
                ctx.fillText('Нет контрольных точек для отображения', ctx2.width / 2, ctx2.height / 2);
            }
        });
}

function renderHeader(data) {
    // Защита от отсутствующих данных
    if (!data) {
        console.warn('renderHeader: данные отсутствуют');
        return;
    }
    
    const group = data.group || {};
    const subject = group.subject || group.course || '';
    const course = subject ? `, дисциплина: <strong>${subject}</strong>` : '';
    const form = group.education_form ? `, форма: ${group.education_form}` : '';
    const monthSelect = document.getElementById('monthSelect');
    const dateInfo = (monthSelect && monthSelect.value) ? `, месяц: ${monthSelect.value}` : '';
    const stats = data.stats || {};
    const counts = (stats.month_lessons != null && stats.total_lessons != null)
        ? `, занятия: <strong>${stats.month_lessons}</strong> за месяц / <strong>${stats.total_lessons}</strong> всего`
        : '';
    
    const headerElement = document.getElementById('journalHeader');
    if (headerElement) {
        headerElement.innerHTML = `
            <div class="alert alert-secondary py-2">
                Группа: <strong>${group.name || 'Не выбрана'}</strong>${course}${form}${dateInfo}${counts}
            </div>
        `;
    } else {
        console.error('Элемент journalHeader не найден');
    }
}

function getCellClass(value) {
    if (!value) return '';
    switch(value.toString().trim()) {
        case '5': return 'text-success';
        case '4': return 'text-primary';
        case '3': return 'text-warning';
        case 'Н': case 'н': case 'Н.': case 'н.': return 'text-danger';
        default: return '';
    }
}

function showCellTooltip(inputEl) {
    if (inputEl.value.trim() === '') {
        // Показываем подсказку только для пустых ячеек
        const tooltip = document.createElement('div');
        tooltip.className = 'cell-tooltip';
        tooltip.innerHTML = '5/4/3/Н';
        tooltip.style.cssText = `
            position: absolute;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        `;
        
        // Позиционируем подсказку
        const rect = inputEl.getBoundingClientRect();
        tooltip.style.left = (rect.left + rect.width / 2 - 35) + 'px';
        tooltip.style.top = (rect.bottom + 8) + 'px';
        
        document.body.appendChild(tooltip);
        inputEl.dataset.tooltip = 'true';
        
        // Убираем подсказку через 2.5 секунды
        setTimeout(() => {
            if (tooltip.parentNode) {
                tooltip.parentNode.removeChild(tooltip);
            }
        }, 2500);
    }
}

function hideCellTooltip(inputEl) {
    const tooltips = document.querySelectorAll('.cell-tooltip');
    tooltips.forEach(tooltip => {
        if (tooltip.parentNode) {
            tooltip.parentNode.removeChild(tooltip);
        }
    });
}

function saveCell(inputEl) {
    const studentId = parseInt(inputEl.dataset.student);
    const lessonId = parseInt(inputEl.dataset.lesson);
    const raw = (inputEl.value || '').trim();

    fetch('/api/journal/mark', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ student_id: studentId, lesson_id: lessonId, value: raw })
    })
    .then(r => r.json())
    .then(res => {
        if (res.error) {
            alert('Ошибка: ' + res.error);
            return;
        }
        
        // Обновляем отображение ячейки
        let value = '';
        if (res.present === false) {
            value = 'Н';
        } else if (res.present === true) {
            value = res.mark || '';
        }
        // Если res.present === null, value остается пустым
        
        inputEl.value = value;
        
        // Обновляем стили
        const cellClass = getCellClass(value);
        inputEl.className = `form-control form-control-sm border-0 text-center journal-input ${cellClass}`;
        inputEl.style.fontWeight = value ? 'bold' : 'normal';
    })
    .catch(err => {
        console.error(err);
        alert('Не удалось сохранить значение');
    });
}

// Подсветка строк и столбцов в таблице журнала
let activeColIndex = null;
let activeRowEl = null;

function attachHighlightHandlers() {
    const table = document.querySelector('#attendanceTable table');
    if (!table) return;

    // События наведения мыши
    table.addEventListener('mousemove', (e) => {
        // Подсветку рассчитываем только по ячейкам тела таблицы, шапку не трогаем
        const cell = e.target.closest('td');
        if (!cell || !table.contains(cell)) return;
        const row = cell.parentElement;
        const colIndex = cell.cellIndex;
        applyHoverHighlight(table, row, colIndex);
    });

    table.addEventListener('mouseleave', () => {
        clearHoverHighlight(table);
    });

    // Фокус/блюр для инпутов
    table.addEventListener('focusin', (e) => {
        const input = e.target.closest('input');
        if (!input) return;
        const cell = input.closest('td');
        if (!cell) return;
        const row = cell.parentElement;
        const colIndex = cell.cellIndex;
        setActiveHighlight(table, row, colIndex);
    });

    table.addEventListener('focusout', (e) => {
        const input = e.target.closest('input');
        if (!input) return;
        // Убираем активную подсветку, но оставляем ховер, если есть
        clearActiveHighlight(table);
    });
}

function applyHoverHighlight(table, rowEl, colIndex) {
    clearHoverHighlight(table);
    if (rowEl) rowEl.classList.add('highlight-row');
    highlightColumn(table, colIndex, 'highlight-col');
}

function clearHoverHighlight(table) {
    table.querySelectorAll('tr.highlight-row').forEach(tr => tr.classList.remove('highlight-row'));
    table.querySelectorAll('.highlight-col').forEach(td => td.classList.remove('highlight-col'));
}

function setActiveHighlight(table, rowEl, colIndex) {
    clearActiveHighlight(table);
    activeRowEl = rowEl;
    activeColIndex = colIndex;
    if (activeRowEl) activeRowEl.classList.add('active-row');
    highlightColumn(table, activeColIndex, 'active-col');
}

function clearActiveHighlight(table) {
    const scope = table || document;
    scope.querySelectorAll('tr.active-row').forEach(tr => tr.classList.remove('active-row'));
    scope.querySelectorAll('.active-col').forEach(td => td.classList.remove('active-col'));
    activeRowEl = null;
    activeColIndex = null;
}

function highlightColumn(table, colIndex, className) {
    if (colIndex == null) return;
    // Тело
    table.querySelectorAll('tbody tr').forEach(tr => {
        const td = tr.children[colIndex];
        if (td) td.classList.add(className);
    });
}

function showAddLesson() {
    new bootstrap.Modal(document.getElementById('lessonModal')).show();
}

function createLesson() {
    const groupId = document.getElementById('groupSelect').value;
    const date = document.getElementById('lessonDate').value;
    const topic = document.getElementById('lessonTopic').value;
    const notes = document.getElementById('lessonNotes').value;

    fetch('/api/lessons', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            group_id: groupId,
            date: date + 'T09:00:00',
            topic: topic,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
        loadJournal();
    });
}

function openLessonModal(lessonId, dateStr) {
    fetch(`/api/lesson/${lessonId}`)
        .then(r => r.json())
        .then(lesson => {
            document.getElementById('lessonModalTitle').textContent = `Занятие ${dateStr}`;
            document.getElementById('lessonTopic').value = lesson.topic || '';
            document.getElementById('lessonNotes').value = lesson.notes || '';
            const saveBtn = document.getElementById('lessonSaveBtn');
            saveBtn.textContent = 'Сохранить';
            saveBtn.onclick = function() { updateLesson(lesson.id); };
            new bootstrap.Modal(document.getElementById('lessonModal')).show();
        });
}

function updateLesson(lessonId) {
    const topic = document.getElementById('lessonTopic').value;
    const notes = document.getElementById('lessonNotes').value;
    fetch(`/api/lesson/${lessonId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ topic, notes })
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('lessonModal')).hide();
            loadJournal();
        } else {
            alert('Ошибка сохранения: ' + (res.error || 'Неизвестная ошибка'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Ошибка сети при сохранении занятия');
    });
}

function showLessonsList() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) { alert('Выберите группу'); return; }
    fetch(`/api/lessons?group_id=${groupId}`)
        .then(r => r.json())
        .then(allLessons => {
            const month = document.getElementById('monthSelect').value;
            let lessons = allLessons;
            if (month) {
                lessons = allLessons.filter(l => l.date.startsWith(month));
            }

            if (lessons.length === 0) {
                document.getElementById('lessonsListContainer').innerHTML = '<div class="alert alert-info">Занятия не найдены</div>';
                new bootstrap.Modal(document.getElementById('lessonsListModal')).show();
                return;
            }

            let html = '<div class="list-group">';
            lessons.sort((a,b) => new Date(a.date) - new Date(b.date));
            lessons.forEach(l => {
                const d = new Date(l.date);
                const dateStr = d.toLocaleDateString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric' });
                const topic = (l.topic || '').trim() || '(без темы)';
                const notes = (l.notes || '').trim();
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${dateStr}</h6>
                            <button class="btn btn-sm btn-outline-primary" onclick="openEditLessonModal(${l.id})">
                                <i class="bi bi-pencil"></i> Редактировать
                            </button>
                        </div>
                        <p class="mb-1"><strong>Тема:</strong> ${escapeHtml(topic)}</p>
                        ${notes ? `<small class="text-muted"><strong>Заметки:</strong> ${escapeHtml(notes)}</small>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            document.getElementById('lessonsListContainer').innerHTML = html;
            new bootstrap.Modal(document.getElementById('lessonsListModal')).show();
        });
}

function openEditLessonModal(lessonId) {
    fetch(`/api/lesson/${lessonId}`)
        .then(r => r.json())
        .then(lesson => {
            document.getElementById('editLessonId').value = lesson.id;
            document.getElementById('editLessonTopic').value = lesson.topic || '';
            document.getElementById('editLessonNotes').value = lesson.notes || '';
            new bootstrap.Modal(document.getElementById('editLessonModal')).show();
        });
}

function saveLessonEdits() {
    const lessonId = document.getElementById('editLessonId').value;
    const topic = document.getElementById('editLessonTopic').value;
    const notes = document.getElementById('editLessonNotes').value;

    fetch(`/api/lesson/${lessonId}`, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ topic, notes })
    })
    .then(r => r.json())
    .then(res => {
        if (res.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editLessonModal')).hide();
            // Обновляем список занятий и таблицу
            const groupId = document.getElementById('groupSelect').value;
            if (document.getElementById('lessonsListModal').classList.contains('show')) {
                showLessonsList();
            }
            if (groupId) {
                loadJournal();
            }
        } else {
            alert('Ошибка сохранения: ' + (res.error || 'Неизвестная ошибка'));
        }
    })
    .catch(err => {
        console.error(err);
        alert('Ошибка сети при сохранении занятия');
    });
}

function escapeHtml(str) {
    return String(str).replace(/[&<>"]/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]);
    });
}

function loadStats() {
    const groupId = document.getElementById('groupSelect').value;

    fetch(`/api/attendance/stats?group_id=${groupId}`)
        .then(r => r.json())
        .then(stats => {
            let html = '<table class="table"><thead><tr><th>Студент</th><th>Посещаемость</th></tr></thead><tbody>';
            stats.forEach(s => {
                html += `<tr><td>${s.student}</td><td>${s.percentage}% (${s.present}/${s.total})</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('statsContainer').innerHTML = html;
        });
}

function exportData() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) return;

    fetch(`/export/attendance/${groupId}`)
        .then(r => r.json())
        .then(data => {
            window.open(data.file, '_blank');
        });
}

function syncFromCalendar() {
    if (!confirm('Синхронизировать занятия из календаря в журнал? Это добавит новые занятия и обновит существующие.')) {
        return;
    }
    
    // Показываем индикатор загрузки
    const syncBtn = event.target;
    const originalText = syncBtn.innerHTML;
    syncBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Синхронизация...';
    syncBtn.disabled = true;
    
    fetch('/api/schedule/sync-to-journal', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert(`Синхронизация завершена!\nСоздано занятий: ${data.created}\nОбновлено занятий: ${data.updated}`);
            // Перезагружаем журнал
            loadJournal();
        } else {
            alert('Ошибка синхронизации: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Ошибка синхронизации: ' + error.message);
    })
    .finally(() => {
        // Восстанавливаем кнопку
        syncBtn.innerHTML = originalText;
        syncBtn.disabled = false;
    });
}

// Функции для работы с контрольными точками
let currentControlPointId = null;

function showAddControlPoint() {
    const groupId = document.getElementById('groupSelect').value;
    if (!groupId) {
        alert('Выберите группу');
        return;
    }
    
    // Очищаем форму
    document.getElementById('controlPointDate').value = '';
    document.getElementById('controlPointTitle').value = 'КТ';
    document.getElementById('controlPointMaxPoints').value = '100';
    
    new bootstrap.Modal(document.getElementById('controlPointModal')).show();
}

function createControlPoint() {
    const groupId = document.getElementById('groupSelect').value;
    const date = document.getElementById('controlPointDate').value;
    const title = document.getElementById('controlPointTitle').value;
    const maxPoints = parseInt(document.getElementById('controlPointMaxPoints').value);

    if (!date) {
        alert('Укажите дату');
        return;
    }

    const data = {
        group_id: parseInt(groupId),
        date: date,
        title: title || 'КТ',
        max_points: maxPoints || 100
    };

    fetch('/api/control-point/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('controlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при создании контрольной точки: ' + error.message);
    });
}

function openControlPointModal(controlPointId, dateStr, title, maxPoints) {
    currentControlPointId = controlPointId;
    
    document.getElementById('editControlPointDate').value = dateStr.split('.').reverse().join('-');
    document.getElementById('editControlPointTitle').value = title;
    document.getElementById('editControlPointMaxPoints').value = maxPoints;
    
    new bootstrap.Modal(document.getElementById('editControlPointModal')).show();
}

function updateControlPoint() {
    if (!currentControlPointId) return;
    
    const date = document.getElementById('editControlPointDate').value;
    const title = document.getElementById('editControlPointTitle').value;
    const maxPoints = parseInt(document.getElementById('editControlPointMaxPoints').value);

    const data = {
        date: date,
        title: title,
        max_points: maxPoints
    };

    fetch(`/api/control-point/${currentControlPointId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editControlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении контрольной точки: ' + error.message);
    });
}

function deleteControlPoint() {
    if (!currentControlPointId) return;
    
    if (!confirm('Вы уверены, что хотите удалить эту контрольную точку? Все оценки будут удалены.')) {
        return;
    }

    fetch(`/api/control-point/${currentControlPointId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('editControlPointModal')).hide();
            loadJournal(); // Перезагружаем журнал
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при удалении контрольной точки: ' + error.message);
    });
}

function saveControlPointScore(inputEl) {
    const studentId = inputEl.dataset.student;
    const controlPointId = inputEl.dataset.controlPoint;
    const maxPoints = parseInt(inputEl.dataset.maxPoints);
    let points = inputEl.value.trim();

    // Валидация
    if (points === '') {
        points = null;
    } else {
        points = parseInt(points);
        if (isNaN(points) || points < 0 || points > maxPoints) {
            alert(`Баллы должны быть от 0 до ${maxPoints}`);
            inputEl.focus();
            return;
        }
    }

    const data = {
        control_point_id: parseInt(controlPointId),
        student_id: parseInt(studentId),
        points: points
    };

    fetch('/api/control-point/score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Обновляем стили
            inputEl.style.fontWeight = points !== null ? 'bold' : 'normal';
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении оценки: ' + error.message);
    });
}
</script>

<style>
/* Стили для ячеек журнала */
.journal-input {
    transition: all 0.2s ease;
    background: transparent !important;
    color: var(--text-primary) !important;
}

.journal-input:hover {
    background: rgba(0, 123, 255, 0.1) !important;
    border: 1px solid rgba(0, 123, 255, 0.3) !important;
}

.journal-input:focus {
    background: rgba(0, 123, 255, 0.15) !important;
    border: 1px solid #007bff !important;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important;
}

/* Цвета для оценок - адаптивные под темы */
.journal-input.text-success {
    color: #198754 !important;
}

.journal-input.text-primary {
    color: #0d6efd !important;
}

.journal-input.text-warning {
    color: #fd7e14 !important;
}

/* Специальная обработка для Н - серые оттенки */
.journal-input.text-danger {
    color: #6c757d !important; /* Темно-серый для светлой темы */
}

/* Темная тема - переопределение цветов */
[data-theme="dark"] .journal-input.text-success {
    color: #20c997 !important;
}

[data-theme="dark"] .journal-input.text-primary {
    color: #6ea8fe !important;
}

[data-theme="dark"] .journal-input.text-warning {
    color: #ffc107 !important;
}

[data-theme="dark"] .journal-input.text-danger {
    color: #adb5bd !important; /* Светло-серый для темной темы */
}

/* Стили для таблицы - адаптивные под темы */
.table-bordered th,
.table-bordered td {
    border: 1px solid var(--border-color) !important;
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
}

.table th {
    background-color: var(--table-header-bg) !important;
    font-weight: 600;
    text-align: center;
    vertical-align: middle;
    color: var(--text-primary) !important;
}

.table tbody tr:hover {
    background-color: var(--table-hover-bg) !important;
}

/* Подсветка строки/столбца при наведении и активном вводе */
.highlight-row td,
.highlight-row th {
    background-color: rgba(102, 126, 234, 0.14) !important;
}

.highlight-col {
    background-color: rgba(102, 126, 234, 0.14) !important;
}

.active-row td,
.active-row th {
    background-color: rgba(102, 126, 234, 0.24) !important;
}

.active-col {
    background-color: rgba(102, 126, 234, 0.24) !important;
}

/* Усиление контраста в темной теме */
[data-theme="dark"] .highlight-row td,
[data-theme="dark"] .highlight-row th,
[data-theme="dark"] .highlight-col {
    background-color: rgba(102, 126, 234, 0.28) !important;
}

[data-theme="dark"] .active-row td,
[data-theme="dark"] .active-row th,
[data-theme="dark"] .active-col {
    background-color: rgba(102, 126, 234, 0.45) !important;
}

/* Визуальное обрамление для лучшей заметности */
.highlight-col { box-shadow: inset 0 0 0 1px rgba(102,126,234,0.5) !important; }
.active-col { box-shadow: inset 0 0 0 2px rgba(102,126,234,0.7) !important; }
.highlight-row td, .highlight-row th { box-shadow: inset 0 0 0 1px rgba(102,126,234,0.4) !important; }
.active-row td, .active-row th { box-shadow: inset 0 0 0 2px rgba(102,126,234,0.6) !important; }

/* Учитываем первую фиксированную колонку, чтобы не было перепадов по z-index */
.table thead th.highlight-col,
.table tbody td.highlight-col,
.table thead th.active-col,
.table tbody td.active-col {
    position: relative;
    z-index: 1;
}

.table thead th:first-child.highlight-col,
.table tbody td:first-child.highlight-col,
.table thead th:first-child.active-col,
.table tbody td:first-child.active-col {
    z-index: 4; /* выше остальных, но ниже закрепленного заголовка */
    /* усиливаем фон для закрепленного первого столбца */
    background-color: rgba(102, 126, 234, 0.32) !important;
}

/* Гарантируем, что первый столбец также получает подсветку строки */
.highlight-row td:first-child,
.active-row td:first-child,
.highlight-row th:first-child,
.active-row th:first-child {
    background-color: rgba(102, 126, 234, 0.32) !important;
    z-index: 4;
}

/* Стили для заголовков дат */
.table th button {
    color: var(--text-primary) !important;
    text-decoration: none;
}

.table th button:hover {
    color: #007bff !important;
    text-decoration: underline;
}

/* Адаптивность */
@media (max-width: 768px) {
    .journal-input {
        min-width: 50px !important;
        font-size: 0.8rem;
    }
    
    .table-responsive {
        font-size: 0.9rem;
    }
}

/* Анимация для подсказок */
.cell-tooltip {
    animation: fadeIn 0.3s ease-in-out;
    background: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border: 1px solid var(--border-color) !important;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Дополнительные стили для лучшей интеграции с темами */
.table-responsive {
    background-color: var(--bg-secondary);
    border-radius: 8px;
    overflow-x: auto; /* включаем горизонтальную прокрутку */
    overflow-y: hidden;
    -webkit-overflow-scrolling: touch; /* плавная прокрутка на мобильных */
    position: relative; /* для корректных контекстов наложения */
    box-shadow: 0 2px 10px var(--shadow-light);
}

.table {
    margin-bottom: 0;
    position: relative; /* повышаем контекст наложения для sticky */
    border-collapse: separate !important; /* sticky корректно работает с separate */
    border-spacing: 0; /* сохраняем внешний вид рамок */
}

/* Не переносим содержимое ячеек, чтобы появлялся горизонтальный скролл */
.table thead th,
.table tbody td {
    white-space: nowrap;
}

/* Первую колонку (студент) можно переносить для читабельности */
.table thead th:first-child,
.table tbody td:first-child {
    white-space: normal;
}

/* Закрепляем первый столбец при горизонтальной прокрутке */
.table thead th:first-child,
.table tbody td:first-child {
    position: -webkit-sticky;
    position: sticky;
    left: 0;
    z-index: 2; /* выше остальных ячеек */
}

/* Заголовок первого столбца поверх данных и с корректным фоном */
.table thead th:first-child {
    z-index: 3;
    background-color: var(--table-header-bg) !important;
    min-width: 220px;
}

/* Тело первого столбца: фон и визуальное разделение */
.table tbody td:first-child {
    background-color: var(--bg-secondary) !important;
    box-shadow: 2px 0 0 0 var(--border-color);
    min-width: 220px;
}

/* Стили для ячеек с данными */
.table td {
    padding: 0.5rem;
    vertical-align: middle;
}

/* Улучшенные стили для input полей в ячейках */
.journal-input {
    border: 1px solid transparent !important;
    border-radius: 4px;
}

.journal-input:not(:focus):not(:hover) {
    border-color: transparent !important;
}

/* Стили для пустых ячеек */
.journal-input:placeholder-shown {
    color: var(--text-secondary) !important;
    font-style: italic;
}

/* Стили для заполненных ячеек */
.journal-input:not(:placeholder-shown) {
    font-weight: bold;
}

/* Стили для контрольных точек */
.control-point-input {
    transition: all 0.2s ease;
    background: transparent !important;
    color: var(--text-primary) !important;
    border: 1px solid transparent !important;
    border-radius: 4px;
}

.control-point-input:hover {
    background: rgba(255, 193, 7, 0.1) !important;
    border: 1px solid rgba(255, 193, 7, 0.3) !important;
}

.control-point-input:focus {
    background: rgba(255, 193, 7, 0.15) !important;
    border: 1px solid #ffc107 !important;
    box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
}

.control-point-input:not(:focus):not(:hover) {
    border-color: transparent !important;
}

/* Стили для заголовков контрольных точек */
.bg-warning.bg-opacity-25 {
    background-color: rgba(255, 193, 7, 0.25) !important;
}

.bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.1) !important;
}

/* Адаптация для темной темы */
[data-theme="dark"] .bg-warning.bg-opacity-25 {
    background-color: rgba(255, 193, 7, 0.15) !important;
}

[data-theme="dark"] .bg-warning.bg-opacity-10 {
    background-color: rgba(255, 193, 7, 0.05) !important;
}

/* Стили для столбца "Итог" */
.bg-info.bg-opacity-25 {
    background-color: rgba(13, 110, 253, 0.25) !important;
}

.bg-info.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

/* Адаптация для темной темы */
[data-theme="dark"] .bg-info.bg-opacity-25 {
    background-color: rgba(13, 110, 253, 0.15) !important;
}

[data-theme="dark"] .bg-info.bg-opacity-10 {
    background-color: rgba(13, 110, 253, 0.05) !important;
}

/* Стили для итогового столбца */
.summary-cell {
    min-width: 120px !important;
    font-weight: bold !important;
}

.summary-average {
    font-size: 1rem !important;
    margin-bottom: 2px;
}

.summary-grade {
    font-size: 0.75rem !important;
    font-weight: 600 !important;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}
</style>
{% endblock %}