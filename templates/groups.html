{% extends "base.html" %}
{% block title %}Группы{% endblock %}

{% block content %}
<style>
[data-theme="dark"] .card {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}
[data-theme="dark"] .card .card-header {
    border-bottom-color: var(--border-color) !important;
}
[data-theme="dark"] .card .card-footer {
    border-top-color: var(--border-color) !important;
}
[data-theme="dark"] .table {
    color: var(--text-primary) !important;
}
[data-theme="dark"] .table thead th {
    background-color: var(--table-header-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}
[data-theme="dark"] .table tbody tr {
    background-color: var(--bg-secondary) !important;
}
[data-theme="dark"] .table-hover tbody tr:hover {
    background-color: var(--table-hover-bg) !important;
}
[data-theme="dark"] .table td,
[data-theme="dark"] .table th {
    border-color: var(--border-color) !important;
}
</style>
<h1 class="mb-4">Управление группами</h1>

<div class="row mb-4">
    <div class="col-md-6">
        <a href="{{ url_for('groups.create_group') }}" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Создать группу
        </a>
    </div>
    <div class="col-md-3">
        <div class="input-group">
            <input type="text" class="form-control" id="studentSearch" placeholder="Поиск студента...">
            <button class="btn btn-outline-primary" type="button" onclick="searchStudent()">
                <i class="bi bi-search"></i>
            </button>
        </div>
    </div>
    <div class="col-md-3 text-end">
        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse">
            <i class="bi bi-funnel"></i> Фильтры и сортировка
        </button>
    </div>
</div>

<!-- Результат поиска студента -->
<div id="studentSearchResult" class="mb-3" style="display: none;">
    <div class="card">
        <div class="card-body">
            <h6 class="card-title">
                <i class="bi bi-person-check"></i> Результат поиска
            </h6>
            <div id="studentSearchContent"></div>
        </div>
    </div>
</div>

<!-- Панель фильтров и сортировки -->
<div class="collapse mb-4" id="filtersCollapse">
    <div class="card">
        <div class="card-body">
            <form method="GET" id="filterForm">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="course" class="form-label">Курс</label>
                        <select class="form-select" id="course" name="course">
                            <option value="">Все курсы</option>
                            {% for course in all_courses %}
                            <option value="{{ course }}" {% if course == current_course %}selected{% endif %}>{{ course }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="education_form" class="form-label">Форма обучения</label>
                        <select class="form-select" id="education_form" name="education_form">
                            <option value="">Все формы</option>
                            {% for form in all_education_forms %}
                            <option value="{{ form }}" {% if form == current_education_form %}selected{% endif %}>{{ form }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="sort" class="form-label">Сортировка</label>
                        <select class="form-select" id="sort" name="sort">
                            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>По названию</option>
                            <option value="course" {% if current_sort == 'course' %}selected{% endif %}>По курсу</option>
                            <option value="education_form" {% if current_sort == 'education_form' %}selected{% endif %}>По форме обучения</option>
                            <option value="students_count" {% if current_sort == 'students_count' %}selected{% endif %}>По количеству студентов</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="order" class="form-label">Порядок</label>
                        <select class="form-select" id="order" name="order">
                            <option value="asc" {% if current_order == 'asc' %}selected{% endif %}>По возрастанию</option>
                            <option value="desc" {% if current_order == 'desc' %}selected{% endif %}>По убыванию</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Применить фильтры
                        </button>
                        <a href="{{ url_for('groups.groups') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Сбросить
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Информация о результатах -->
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">
                Найдено групп: <strong>{{ groups|length }}</strong>
                {% if current_course or current_education_form %}
                    (с примененными фильтрами)
                {% endif %}
            </span>
            {% if current_course or current_education_form or current_sort != 'name' or current_order != 'asc' %}
            <a href="{{ url_for('groups.groups') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-clockwise"></i> Сбросить все фильтры
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    {% for group in groups %}
    <div class="col-md-6 col-lg-4 mb-4 group-card" id="group-{{ group.id }}">
        <div class="card h-100">
            <div class="card-header" style="background-color: {{ group.color }}; color: white;">
                <h5 class="card-title mb-0">
                    <i class="bi bi-people"></i> {{ group.name }}
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    <strong>Курс:</strong> {{ group.course }}<br>
                    <strong>Форма обучения:</strong> {{ group.education_form }}<br>
                    <strong>Студентов:</strong> 
                    <span class="badge bg-primary">{{ group.students|length }}</span>
                </p>
            </div>
            <div class="card-footer">
                <div class="btn-group w-100" role="group">
                    <button type="button"
                            class="btn btn-outline-info btn-sm"
                            onclick="toggleSubjects({{ group.id }})">
                        <i class="bi bi-book"></i> Дисциплины
                    </button>
                    <a href="{{ url_for('groups.group_detail', group_id=group.id) }}" 
                       class="btn btn-outline-primary btn-sm">
                        <i class="bi bi-eye"></i> Открыть
                    </a>
                    <a href="{{ url_for('groups.edit_group', group_id=group.id) }}" 
                       class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-pencil"></i> Редактировать
                    </a>
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            onclick="deleteGroup({{ group.id }}, '{{ group.name }}')">
                        <i class="bi bi-trash"></i> Удалить
                    </button>
                </div>
                <div id="subjects-{{ group.id }}" class="mt-3" style="display:none;"></div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info text-center">
            <h4>Группы не найдены</h4>
            {% if current_course or current_education_form %}
                <p>По заданным фильтрам группы не найдены. Попробуйте изменить параметры поиска.</p>
                <a href="{{ url_for('groups.groups') }}" class="btn btn-outline-primary">
                    <i class="bi bi-arrow-clockwise"></i> Сбросить фильтры
                </a>
            {% else %}
                <p>Создайте свою первую группу для начала работы</p>
                <a href="{{ url_for('groups.create_group') }}" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Создать группу
                </a>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Модальное окно подтверждения удаления -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить группу "<span id="groupName"></span>"?</p>
                <p class="text-danger">Это действие нельзя отменить!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
let groupToDelete = null;

function deleteGroup(groupId, groupName) {
    groupToDelete = groupId;
    document.getElementById('groupName').textContent = groupName;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (groupToDelete) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/groups/${groupToDelete}/delete`;
        document.body.appendChild(form);
        form.submit();
    }
});

// Автоматическое применение фильтров при изменении
document.addEventListener('DOMContentLoaded', function() {
    const filterForm = document.getElementById('filterForm');
    const courseSelect = document.getElementById('course');
    const educationFormSelect = document.getElementById('education_form');
    const sortSelect = document.getElementById('sort');
    const orderSelect = document.getElementById('order');
    
    // Сохраняем состояние панели фильтров
    const filtersCollapse = document.getElementById('filtersCollapse');
    const savedState = localStorage.getItem('filtersPanelOpen');
    if (savedState === 'true') {
        const bsCollapse = new bootstrap.Collapse(filtersCollapse, { show: true });
    }
    
    // Отслеживаем изменения состояния панели
    filtersCollapse.addEventListener('shown.bs.collapse', function() {
        localStorage.setItem('filtersPanelOpen', 'true');
    });
    
    filtersCollapse.addEventListener('hidden.bs.collapse', function() {
        localStorage.setItem('filtersPanelOpen', 'false');
    });
    
    // Автоматическое применение фильтров при изменении (с небольшой задержкой)
    let filterTimeout;
    function applyFilters() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            filterForm.submit();
        }, 500); // Задержка 500мс для избежания частых запросов
    }
    
    // Применяем фильтры при изменении селектов
    courseSelect.addEventListener('change', applyFilters);
    educationFormSelect.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);
    orderSelect.addEventListener('change', applyFilters);
    
    // Показываем индикатор загрузки при отправке формы
    filterForm.addEventListener('submit', function() {
        const submitBtn = filterForm.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Загрузка...';
        submitBtn.disabled = true;
        
        // Восстанавливаем кнопку через 3 секунды на случай, если что-то пойдет не так
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 3000);
    });
});

// Показать/скрыть блок с дисциплинами выбранной группы и подгрузить их при первом открытии
function toggleSubjects(groupId) {
    const container = document.getElementById(`subjects-${groupId}`);
    if (!container) return;

    const isHidden = container.style.display === 'none' || container.style.display === '';
    if (isHidden) {
        // Если еще не загружали, помечаем и грузим
        if (!container.dataset.loaded) {
            container.innerHTML = '<div class="text-muted"><i class="bi bi-arrow-repeat spin"></i> Загрузка дисциплин...</div>';
            fetch(`/api/group/subjects?group_id=${groupId}`)
                .then(r => r.json())
                .then(list => {
                    container.dataset.loaded = 'true';
                    if (!Array.isArray(list) || list.length === 0) {
                        container.innerHTML = '<div class="alert alert-light mb-0">Дисциплины не найдены</div>';
                        return;
                    }
                    const items = list.map(s => `<span class="badge bg-secondary me-1 mb-1">${escapeHtml(s)}</span>`).join('');
                    container.innerHTML = `
                        <div>
                            <div class="mb-2 text-muted">Дисциплины группы:</div>
                            ${items}
                        </div>
                    `;
                })
                .catch(() => {
                    container.innerHTML = '<div class="alert alert-warning mb-0">Не удалось загрузить дисциплины</div>';
                });
        }
        container.style.display = 'block';
    } else {
        container.style.display = 'none';
    }
}

// Поиск студента по имени
function searchStudent() {
    const searchInput = document.getElementById('studentSearch');
    const studentName = searchInput.value.trim();
    const resultDiv = document.getElementById('studentSearchResult');
    const contentDiv = document.getElementById('studentSearchContent');
    
    if (!studentName) {
        alert('Введите имя студента для поиска');
        return;
    }
    
    // Показываем индикатор загрузки
    resultDiv.style.display = 'block';
    contentDiv.innerHTML = '<div class="text-muted"><i class="bi bi-arrow-repeat spin"></i> Поиск студента...</div>';
    
    fetch(`/groups/search/student?name=${encodeURIComponent(studentName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                contentDiv.innerHTML = `<div class="alert alert-warning mb-0">${escapeHtml(data.error)}</div>`;
                return;
            }
            
            if (!data.students || data.students.length === 0) {
                contentDiv.innerHTML = '<div class="alert alert-info mb-0">Студент не найден</div>';
                return;
            }
            
            // Скрываем все группы
            const allGroups = document.querySelectorAll('.group-card');
            allGroups.forEach(group => {
                group.style.display = 'none';
            });
            
            // Показываем только группы с найденными студентами
            const foundGroupIds = [...new Set(data.students.map(s => s.group_id))];
            foundGroupIds.forEach(groupId => {
                const groupCard = document.getElementById(`group-${groupId}`);
                if (groupCard) {
                    groupCard.style.display = 'block';
                }
            });
            
            // Отображаем информацию о найденных студентах
            let html = `
                <div class="alert alert-success mb-3">
                    <i class="bi bi-check-circle"></i> Найдено студентов: ${data.students.length}
                </div>
                <div class="row">
            `;
            
            data.students.forEach(student => {
                html += `
                    <div class="col-md-6 mb-2">
                        <div class="card">
                            <div class="card-body py-2">
                                <h6 class="card-title mb-1">
                                    <i class="bi bi-person"></i> ${escapeHtml(student.name)}
                                </h6>
                                <p class="card-text mb-1">
                                    <strong>Группа:</strong> 
                                    <a href="/groups/${student.group_id}" class="text-decoration-none">
                                        ${escapeHtml(student.group_name)}
                                    </a>
                                </p>
                                <small class="text-muted">
                                    Курс: ${escapeHtml(student.course || 'Не указан')} | 
                                    Форма: ${escapeHtml(student.education_form || 'Не указана')}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Добавляем кнопку сброса
            html += `
                <div class="mt-3 text-center">
                    <button class="btn btn-outline-secondary" onclick="resetSearch()">
                        <i class="bi bi-arrow-clockwise"></i> Показать все группы
                    </button>
                </div>
            `;
            
            contentDiv.innerHTML = html;
        })
        .catch(error => {
            console.error('Ошибка поиска:', error);
            contentDiv.innerHTML = '<div class="alert alert-danger mb-0">Ошибка при поиске студента</div>';
        });
}

// Сброс поиска - показать все группы
function resetSearch() {
    const allGroups = document.querySelectorAll('.group-card');
    allGroups.forEach(group => {
        group.style.display = 'block';
    });
    
    const resultDiv = document.getElementById('studentSearchResult');
    const searchInput = document.getElementById('studentSearch');
    
    resultDiv.style.display = 'none';
    searchInput.value = '';
}

// Поиск по нажатию Enter
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('studentSearch');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudent();
            }
        });
    }
});

// Простейший escape для вставки текста в HTML
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}
</script>
{% endblock %}





