{% extends "base.html" %}
{% block title %}Облачные папки{% endblock %}

{% block content %}
<h1 class="mb-4">Облачные папки и файлы</h1>

<div class="row mb-4">
    <div class="col-md-12 d-flex gap-2">
        <button class="btn btn-primary" onclick="createFolder()">
            <i class="bi bi-folder-plus"></i> Создать папку
        </button>
        <button class="btn btn-danger" onclick="deleteSelected()">
            <i class="bi bi-trash"></i> Удалить выбранное
        </button>
        <button class="btn btn-secondary" onclick="renameSelected()">
            <i class="bi bi-pencil"></i> Переименовать
        </button>
        <div class="btn-group" role="group">
            <label class="btn btn-success mb-0">
                <i class="bi bi-upload"></i> Выбрать файл
                <input type="file" id="fileInput" hidden>
            </label>
            <button class="btn btn-success" onclick="uploadToSelected()">
                <i class="bi bi-cloud-upload"></i> В выбранные
            </button>
        </div>
        <button class="btn btn-outline-secondary" onclick="refreshCloud()">
            <i class="bi bi-arrow-clockwise"></i> Обновить
        </button>
    </div>
</div>

<!-- Убрали старую сводку -->

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                Группы
            </div>
            <div class="card-body">
                <ul class="list-group" id="groupList">
                    {% for g, folders in cloud_folders.items() %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><i class="bi bi-people me-2"></i>{{ g }}</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="openGroup('{{ g }}')">Открыть</button>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span id="currentPath">Путь: /</span>
                <small class="text-muted">WebDAV</small>
            </div>
            <div class="card-body">
                <ul class="list-group" id="folderList">
                    <li class="list-group-item text-muted">Выберите группу слева</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Удалено модальное окно создания заданий -->

<!-- Удалено модальное окно проверки заданий -->

<div class="mt-4">
    <div id="statsContainer"></div>
</div>

<script>
let currentGroup = null;
let currentPath = '';

function openGroup(groupName) {
    currentGroup = groupName;
    currentPath = '';
    document.getElementById('currentPath').textContent = `Путь: /${groupName}`;
    loadFolder('');
}

function loadFolder(path) {
    fetch(`/api/cloud/list?group=${encodeURIComponent(currentGroup)}&path=${encodeURIComponent(path)}`)
        .then(r => r.json())
        .then(data => {
            currentPath = data.path.replace(/^.*?\//, '');
            const list = document.getElementById('folderList');
            list.innerHTML = '';
            if (!data.items || data.items.length === 0) {
                list.innerHTML = '<li class="list-group-item text-muted">Пусто</li>';
                return;
            }
            data.items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `
                    <div>
                        <input type="checkbox" class="form-check-input me-2 select-item" data-path="${toRel(item.path)}">
                        <i class="bi ${item.type==='file'?'bi-file-earmark':'bi-folder'} me-2"></i>
                        ${item.type==='file' ? `<a href="/api/cloud/download?target=${encodeURIComponent(toRel(item.path))}">${item.name}</a>` : `<a href="#" onclick="navigate('${item.path}'); return false;">${item.name}</a>`}
                    </div>
                    ${item.type==='file' ? `<a class="btn btn-sm btn-outline-success" href="/api/cloud/download?target=${encodeURIComponent(toRel(item.path))}"><i class=\"bi bi-download\"></i> Скачать</a>` : `<button class="btn btn-sm btn-outline-secondary" onclick="navigate('${item.path}')">Открыть</button>`}
                `;
                list.appendChild(li);
            });
        })
}

function navigate(fullPath) {
    // fullPath: абсолютный путь в облаке; преобразуем к относительному от группы
    const parts = fullPath.split('/');
    const name = parts[parts.length - 1] || parts[parts.length - 2];
    const next = currentPath ? `${currentPath}/${name}` : name;
    document.getElementById('currentPath').textContent = `Путь: /${currentGroup}/${next}`;
    loadFolder(next);
}

function refreshCloud() {
    if (!currentGroup) return;
    loadFolder(currentPath);
}

function createFolder() {
    if (!currentGroup) { alert('Выберите группу'); return; }
    const name = prompt('Имя новой папки:');
    if (!name) return;
    fetch('/api/cloud/mkdir', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({group: currentGroup, path: currentPath, name})
    }).then(() => refreshCloud());
}

function getSelected() {
    return Array.from(document.querySelectorAll('.select-item:checked')).map(cb => cb.getAttribute('data-path'));
}

function deleteSelected() {
    const sel = getSelected();
    if (sel.length === 0) { alert('Выберите элементы'); return; }
    if (!confirm('Удалить выбранное?')) return;
    Promise.all(sel.map(p => fetch('/api/cloud/delete', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({target: toRelative(p)})
    }))).then(() => refreshCloud());
}

function renameSelected() {
    const sel = getSelected();
    if (sel.length !== 1) { alert('Выберите один элемент'); return; }
    const newName = prompt('Новое имя:');
    if (!newName) return;
    const rel = toRelative(sel[0]);
    const dst = rel.split('/').slice(0, -1).concat([newName]).join('/');
    fetch('/api/cloud/rename', {
        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({src: rel, dst})
    }).then(() => refreshCloud());
}

function toRelative(fullPath) {
    // Преобразуем абсолютный путь облака в относительный {group}/{subpath}
    const idx = fullPath.lastIndexOf('/' + currentGroup + '/');
    if (idx >= 0) return fullPath.substring(idx + 1);
    // fallback: если нет, собираем из UI текущего пути
    const parts = fullPath.split('/');
    const name = parts[parts.length - 1] || parts[parts.length - 2];
    const sp = currentPath ? `${currentPath}/${name}` : name;
    return `${currentGroup}/${sp}`;
}

function uploadToSelected(){
    if (!currentGroup) { alert('Выберите группу'); return; }
    const input = document.getElementById('fileInput');
    if (!input.files || input.files.length===0) { alert('Выберите файл'); return; }
    const selected = Array.from(document.querySelectorAll('.select-item:checked')).map(cb => cb.getAttribute('data-path'));
    // Если ничего не выбрано — загрузим в текущую открытую папку
    const targets = selected.length>0 ? selected : [`${currentGroup}/${currentPath}`.replace(/\/$/, '')];
    const file = input.files[0];
    Promise.all(targets.map(t => {
        const relParts = t.split('/');
        const group = relParts[0];
        const folder = relParts.slice(1).join('/');
        const form = new FormData();
        form.append('group', group);
        form.append('path', folder);
        form.append('file', file);
        return fetch('/api/cloud/upload', { method: 'POST', body: form });
    })).then(()=>{ input.value=''; refreshCloud(); });
}
function toRel(fullPath){
    const idx = fullPath.lastIndexOf('/' + currentGroup + '/');
    if (idx >= 0) return fullPath.substring(idx + 1);
    const parts = fullPath.split('/');
    const name = parts[parts.length - 1] || parts[parts.length - 2];
    const sp = currentPath ? `${currentPath}/${name}` : name;
    return `${currentGroup}/${sp}`;
}
</script>
{% endblock %}