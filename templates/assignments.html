{% extends "base.html" %}
{% block title %}Задания{% endblock %}

{% block extra_css %}
<style>
    .assignment-card {
        border-radius: 12px;
        box-shadow: 0 4px 20px var(--shadow-light);
        transition: all 0.3s ease;
        margin-bottom: 20px;
    }
    
    .assignment-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px var(--shadow-medium);
    }
    
    .score-input {
        width: 80px;
        text-align: center;
        font-weight: bold;
    }
    
    .score-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .student-row {
        transition: background-color 0.2s ease;
    }
    
    .student-row:hover {
        background-color: var(--table-hover-bg);
    }
    
    .assignment-header {
        background: var(--accent-gradient);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 15px 20px;
    }
    
    .assignment-body {
        padding: 20px;
    }
    
    .due-date {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .overdue {
        color: #dc3545;
        font-weight: bold;
    }
    
    .due-soon {
        color: #ffc107;
        font-weight: bold;
    }
    
    .on-time {
        color: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Задания</h1>

<div class="row mb-4">
    <div class="col-md-4">
        <select id="groupSelect" class="form-select" onchange="loadGroupAssignments()">
            <option value="">Выберите группу</option>
            {% for group in groups %}
            <option value="{{ group.id }}" data-name="{{ group.name }}" data-course="{{ group.course or '' }}">
                {{ group.name }}
            </option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-4">
        <select id="subjectSelect" class="form-select" onchange="loadGroupAssignments()" disabled>
            <option value="">Выберите дисциплину</option>
        </select>
        </div>
    <div class="col-md-4">
        <button class="btn btn-primary" onclick="showCreateAssignmentModal()" id="createBtn" disabled>
            <i class="bi bi-plus-circle"></i> Добавить задание
        </button>
    </div>
</div>

<div id="assignmentsContainer">
    <div class="text-center text-muted py-5">
        <i class="bi bi-journal-text" style="font-size: 3rem;"></i>
        <p class="mt-3">Выберите группу для просмотра заданий</p>
    </div>
            </div>

<!-- Модальное окно создания задания -->
<div class="modal fade" id="createAssignmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать задание</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Название задания</label>
                    <input type="text" id="assignmentTitle" class="form-control" placeholder="Введите название задания" required>
        </div>
                <div class="mb-3">
                    <label class="form-label">Срок выполнения</label>
                    <input type="date" id="assignmentDueDate" class="form-control">
                    <div class="form-text">Оставьте пустым, если срок не ограничен</div>
    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createAssignment()">Создать</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentGroupId = null;
let currentGroupData = null;
let currentSubject = '';

function loadGroupAssignments() {
    const groupSelect = document.getElementById('groupSelect');
    const groupId = groupSelect.value;
    const createBtn = document.getElementById('createBtn');
    const subjectSelect = document.getElementById('subjectSelect');
    
    if (!groupId) {
        createBtn.disabled = true;
        subjectSelect.innerHTML = '<option value="">Выберите дисциплину</option>';
        subjectSelect.disabled = true;
        document.getElementById('assignmentsContainer').innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-journal-text" style="font-size: 3rem;"></i>
                <p class="mt-3">Выберите группу для просмотра заданий</p>
            </div>
        `;
        return;
    }
    
    createBtn.disabled = false;
    currentGroupId = groupId;
    
    // Если дисциплина ещё не загружена — подгружаем список дисциплин группы
    if (subjectSelect.disabled) {
        subjectSelect.innerHTML = '<option value="">Загрузка дисциплин...</option>';
        fetch(`/api/group/subjects?group_id=${groupId}`)
        .then(r => r.json())
            .then(subjects => {
                let options = '<option value="">Выберите дисциплину</option>';
                subjects.forEach(s => { options += `<option value="${s}">${s}</option>`; });
                subjectSelect.innerHTML = options;
                subjectSelect.disabled = false;
            })
            .catch(() => {
                subjectSelect.innerHTML = '<option value="">Выберите дисциплину</option>';
                subjectSelect.disabled = false;
            });
        // Пока дисциплина не выбрана — не грузим задания
        document.getElementById('assignmentsContainer').innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-journal-text" style="font-size: 3rem;"></i>
                <p class="mt-3">Выберите дисциплину</p>
            </div>
        `;
        return;
    }
    
    currentSubject = subjectSelect.value || '';
    
    // Показываем загрузку
    document.getElementById('assignmentsContainer').innerHTML = `
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-3">Загрузка заданий...</p>
        </div>
    `;
    
    const qs = new URLSearchParams();
    if (currentSubject) qs.set('subject', currentSubject);
    fetch(`/api/assignments/group/${groupId}?${qs.toString()}`)
        .then(response => response.json())
        .then(data => {
            currentGroupData = data;
            renderAssignments(data);
        })
        .catch(error => {
            console.error('Ошибка загрузки заданий:', error);
            document.getElementById('assignmentsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle"></i>
                    Ошибка загрузки заданий. Попробуйте обновить страницу.
                </div>
            `;
        });
}

function renderAssignments(data) {
    const container = document.getElementById('assignmentsContainer');
    
    if (!data.assignments || data.assignments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="bi bi-journal-text" style="font-size: 3rem;"></i>
                <p class="mt-3">В группе "${data.group.name}" пока нет заданий</p>
                <p class="text-muted">Создайте первое задание для студентов</p>
            </div>
        `;
                return;
    }
    
    let html = `
        <div class="mb-3">
            <h4>Группа: ${data.group.name}</h4>
            ${data.group.course ? `<p class="text-muted">Курс: ${data.group.course}</p>` : ''}
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th style="min-width: 200px;">Студент</th>
    `;
    
    // Заголовки столбцов (задания)
    data.assignments.forEach(assignment => {
        const dueDate = assignment.due_date ? new Date(assignment.due_date) : null;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        let dueDateHtml = '';
        let dueDateClass = '';
        
        if (dueDate) {
            dueDate.setHours(0, 0, 0, 0);
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                dueDateClass = 'text-danger';
                dueDateHtml = `<br><small class="${dueDateClass}">Просрочено</small>`;
            } else if (diffDays <= 3) {
                dueDateClass = 'text-warning';
                dueDateHtml = `<br><small class="${dueDateClass}">Срок: ${diffDays} дн.</small>`;
            } else {
                dueDateClass = 'text-success';
                dueDateHtml = `<br><small class="${dueDateClass}">Срок: ${diffDays} дн.</small>`;
            }
        } else {
            dueDateHtml = '<br><small class="text-muted">Без срока</small>';
        }
        
        html += `<th class="text-center" style="min-width: 120px;">${assignment.title}${dueDateHtml}</th>`;
    });
    
    html += `
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Строки студентов
    data.students.forEach(student => {
        html += `<tr><td><strong>${student.name}</strong></td>`;
        
        data.assignments.forEach(assignment => {
            const key = `${assignment.title}_${assignment.due_date || 'no_date'}`;
            const studentData = data.scores_matrix[student.id] && data.scores_matrix[student.id][key];
            const score = studentData ? studentData.score : null;
            const checkedAt = studentData ? studentData.checked_at : null;
            const assignmentId = studentData ? studentData.assignment_id : null;
            
            let statusIcon = '';
            if (checkedAt) {
                statusIcon = ' <i class="bi bi-check-circle text-success" title="Проверено"></i>';
            } else {
                statusIcon = ' <i class="bi bi-circle text-muted" title="Не проверено"></i>';
            }
            
            html += `
                <td class="text-center">
                    <div class="d-flex align-items-center justify-content-center gap-1">
                        <input type="number" 
                               class="form-control score-input" 
                               min="0" 
                               max="100" 
                               step="0.1"
                               value="${score || ''}" 
                               placeholder="0-100"
                               data-student-id="${student.id}"
                               data-assignment-title="${assignment.title}"
                               data-assignment-due-date="${assignment.due_date || ''}"
                               data-assignment-id="${assignmentId || ''}"
                               onchange="updateScore(this)"
                               style="width: 80px;">
                        ${statusIcon}
                    </div>
                </td>
            `;
        });
        
        html += '</tr>';
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

function showCreateAssignmentModal() {
    if (!currentGroupId) {
        alert('Выберите группу');
        return;
    }
    const subjectSelect = document.getElementById('subjectSelect');
    if (!subjectSelect.value) {
        alert('Выберите дисциплину');
        return;
    }
    
    // Очищаем форму
    document.getElementById('assignmentTitle').value = '';
    document.getElementById('assignmentDueDate').value = '';
    
    new bootstrap.Modal(document.getElementById('createAssignmentModal')).show();
}

function createAssignment() {
    const title = document.getElementById('assignmentTitle').value.trim();
    const dueDate = document.getElementById('assignmentDueDate').value;
    
    if (!title) {
        alert('Введите название задания');
        return;
    }
    
    const data = {
        group_id: currentGroupId,
        title: title,
        due_date: dueDate || null,
        subject: document.getElementById('subjectSelect').value || null
    };
    
    fetch('/api/assignments/create', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            bootstrap.Modal.getInstance(document.getElementById('createAssignmentModal')).hide();
            loadGroupAssignments(); // Перезагружаем список заданий
        } else {
            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
        }
    })
    .catch(error => {
        console.error('Ошибка создания задания:', error);
        alert('Ошибка создания задания');
    });
}

function updateScore(input) {
    const studentId = input.dataset.studentId;
    const assignmentTitle = input.dataset.assignmentTitle;
    const assignmentDueDate = input.dataset.assignmentDueDate;
    const assignmentId = input.dataset.assignmentId;
    const score = input.value;
    
    if (!assignmentId) {
        alert('Ошибка: задание не найдено');
        return;
    }
    
    fetch('/api/assignments/score', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            assignment_id: assignmentId,
            score: score
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.status === 'success') {
            // Обновляем стиль поля ввода
            input.style.borderColor = '#28a745';
            setTimeout(() => {
                input.style.borderColor = '';
            }, 2000);
            
            // Обновляем иконку статуса
            const icon = input.parentElement.querySelector('i');
            if (icon) {
                icon.className = 'bi bi-check-circle text-success';
                icon.title = 'Проверено';
            }
        } else {
            alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
            // Возвращаем предыдущее значение
            input.value = '';
        }
    })
    .catch(error => {
        console.error('Ошибка обновления оценки:', error);
        alert('Ошибка обновления оценки');
        input.value = '';
    });
}
</script>
{% endblock %}