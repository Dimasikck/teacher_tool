{% extends "base.html" %}
{% block title %}{{ group.name }} - Детали группы{% endblock %}

{% block content %}
<style>
[data-theme="dark"] .card {
    background-color: var(--bg-secondary) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}
[data-theme="dark"] .card .card-header {
    border-bottom-color: var(--border-color) !important;
}
[data-theme="dark"] .card .card-body {
    background-color: var(--bg-secondary) !important;
}
[data-theme="dark"] .card .card-footer {
    border-top-color: var(--border-color) !important;
}
[data-theme="dark"] .table-responsive {
    background-color: var(--bg-secondary) !important;
}
[data-theme="dark"] .card .table {
    color: var(--text-primary) !important;
}
[data-theme="dark"] .card .table thead th {
    background-color: var(--table-header-bg) !important;
    color: var(--text-primary) !important;
    border-color: var(--border-color) !important;
}
[data-theme="dark"] .card .table tbody tr {
    background-color: var(--bg-secondary) !important;
}
[data-theme="dark"] .card .table-hover tbody tr:hover {
    background-color: var(--table-hover-bg) !important;
}
[data-theme="dark"] .card .table td,
[data-theme="dark"] .card .table th {
    border-color: var(--border-color) !important;
}
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-0">
            <span class="badge" style="background-color: {{ group.color }}; color: white; font-size: 1rem;">
                {{ group.name }}
            </span>
        </h1>
        <p class="text-muted mb-0">{{ group.course }} • {{ group.education_form }}</p>
    </div>
    <div>
        <a href="{{ url_for('groups.edit_group', group_id=group.id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Редактировать
        </a>
        <a href="{{ url_for('groups.groups') }}" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Назад к группам
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-people text-primary"></i>
                </h5>
                <h3 class="text-primary">{{ students|length }}</h3>
                <p class="card-text">Студентов в группе</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-book text-success"></i>
                </h5>
                <h3 class="text-success">{{ group.course }}</h3>
                <p class="card-text">Курс</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-mortarboard text-info"></i>
                </h5>
                <h3 class="text-info">{{ group.education_form }}</h3>
                <p class="card-text">Форма обучения</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-person-lines-fill"></i> Список студентов
                </h5>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm" onclick="sortTableRows()" title="Сортировать по алфавиту">
                        <i class="bi bi-sort-alpha-down"></i> Сортировать
                    </button>
                    <button class="btn btn-primary btn-sm" onclick="showAddStudentModal()">
                        <i class="bi bi-plus-circle"></i> Добавить студента
                    </button>
                    <button class="btn btn-success btn-sm" onclick="showAddStudentsBatchModal()">
                        <i class="bi bi-plus-square"></i> Добавить списком
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if students %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Имя</th>
                                <th>Email</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr data-student-id="{{ student.id }}">
                                <td>{{ loop.index }}</td>
                                <td>{{ student.name }}</td>
                                <td>{{ student.email or '-' }}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="editStudent({{ student.id }}, '{{ student.name }}', '{{ student.email or '' }}')">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="deleteStudent({{ student.id }}, '{{ student.name }}')">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-person-x display-1 text-muted"></i>
                    <h4 class="text-muted">Студенты не найдены</h4>
                    <p class="text-muted">Добавьте первого студента в группу</p>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="showAddStudentModal()">
                            <i class="bi bi-plus-circle"></i> Добавить студента
                        </button>
                        <button class="btn btn-success" onclick="showAddStudentsBatchModal()">
                            <i class="bi bi-plus-square"></i> Добавить списком
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления студента -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить студента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addStudentForm">
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Имя студента *</label>
                        <input type="text" class="form-control" id="studentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="studentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="studentEmail">
                        <div class="form-text">Необязательное поле</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="addStudent()">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования студента -->
<div class="modal fade" id="editStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать студента</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editStudentForm">
                    <div class="mb-3">
                        <label for="editStudentName" class="form-label">Имя студента *</label>
                        <input type="text" class="form-control" id="editStudentName" required>
                    </div>
                    <div class="mb-3">
                        <label for="editStudentEmail" class="form-label">Email</label>
                        <input type="email" class="form-control" id="editStudentEmail">
                        <div class="form-text">Необязательное поле</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="saveStudent()">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно массового добавления студентов -->
<div class="modal fade" id="addStudentsBatchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить студентов списком</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="studentsText" class="form-label">Список студентов *</label>
                    <textarea class="form-control" id="studentsText" rows="10" 
                              placeholder="Введите список студентов, каждый с новой строки:&#10;Иван Петров&#10;Мария Сидорова&#10;Алексей Козлов, alexey@example.com&#10;&#10;Поддерживаемые форматы:&#10;- Имя Фамилия&#10;- Имя Фамилия, email@example.com"></textarea>
                    <div class="form-text">Каждый студент на новой строке. Email необязателен.</div>
                </div>
                <div id="batchResult" class="mt-3" style="display: none;">
                    <div id="batchSuccess" class="alert alert-success" style="display: none;"></div>
                    <div id="batchErrors" class="alert alert-danger" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-success" onclick="addStudentsBatch()">Добавить студентов</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно подтверждения удаления студента -->
<div class="modal fade" id="deleteStudentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подтверждение удаления</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Вы уверены, что хотите удалить студента "<span id="studentNameToDelete"></span>"?</p>
                <p class="text-danger">Это действие нельзя отменить!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteStudent">Удалить</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentStudentId = null;

function showAddStudentModal() {
    document.getElementById('addStudentForm').reset();
    new bootstrap.Modal(document.getElementById('addStudentModal')).show();
}

function showAddStudentsBatchModal() {
    document.getElementById('studentsText').value = '';
    document.getElementById('batchResult').style.display = 'none';
    new bootstrap.Modal(document.getElementById('addStudentsBatchModal')).show();
}

function updateStudentsList(newStudents) {
    const tbody = document.querySelector('table tbody');
    const noStudentsDiv = document.querySelector('.text-center.py-4');
    const studentsCount = document.querySelector('.text-primary');
    
    if (!tbody) return;
    
    // Если есть блок "студенты не найдены", скрываем его
    if (noStudentsDiv) {
        noStudentsDiv.style.display = 'none';
    }
    
    // Показываем таблицу если она была скрыта
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
        tableContainer.style.display = 'block';
    }
    
    // Добавляем новых студентов в таблицу
    newStudents.forEach((student, index) => {
        const newRow = document.createElement('tr');
        newRow.setAttribute('data-student-id', student.id || 0);
        newRow.innerHTML = `
            <td>0</td> <!-- Временно, будет обновлено после сортировки -->
            <td>${student.name}</td>
            <td>${student.email || '-'}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                        onclick="editStudent(${student.id || 0}, '${student.name}', '${student.email || ''}')">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" 
                        onclick="deleteStudent(${student.id || 0}, '${student.name}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(newRow);
    });
    
    // Сортируем все строки по алфавиту (включая новые)
    sortTableRows();
    
    // Обновляем счетчик студентов
    if (studentsCount) {
        const currentCount = parseInt(studentsCount.textContent);
        studentsCount.textContent = currentCount + newStudents.length;
    }
    
    // Показываем уведомление об успешном добавлении
    showSuccessNotification(`Добавлено ${newStudents.length} студентов`);
}

function sortTableRows() {
    const tbody = document.querySelector('table tbody');
    if (!tbody) return;
    
    // Получаем все строки
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Сортируем строки по имени студента (вторая колонка)
    rows.sort((a, b) => {
        const nameA = a.querySelector('td:nth-child(2)').textContent.trim();
        const nameB = b.querySelector('td:nth-child(2)').textContent.trim();
        return nameA.localeCompare(nameB, 'ru', { sensitivity: 'base' });
    });
    
    // Очищаем tbody и добавляем отсортированные строки
    tbody.innerHTML = '';
    rows.forEach((row, index) => {
        // Обновляем номер строки
        const firstCell = row.querySelector('td:first-child');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
        tbody.appendChild(row);
    });
}

async function reloadStudentsList() {
    try {
        const response = await fetch(`/groups/{{ group.id }}/students`, { credentials: 'include' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        if (!data || !Array.isArray(data.students)) return;

        const tbody = document.querySelector('table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';

        data.students.forEach((student, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-student-id', student.id);
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${student.name}</td>
                <td>${student.email || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editStudent(${student.id}, '${student.name}', '${student.email || ''}')">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStudent(${student.id}, '${student.name}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (e) {
        console.error('Failed to reload students:', e);
    }
}

function showSuccessNotification(message) {
    // Создаем уведомление
    const notification = document.createElement('div');
    notification.className = 'alert alert-success alert-dismissible fade show position-fixed';
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Автоматически скрываем через 3 секунды
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 3000);
}

function updateStudentInTable(studentId, studentData) {
    // Находим строку с нужным студентом по data-атрибуту
    const rowToUpdate = document.querySelector(`tr[data-student-id="${studentId}"]`);
    
    if (rowToUpdate) {
        // Обновляем данные в строке
        const cells = rowToUpdate.querySelectorAll('td');
        if (cells.length >= 3) {
            cells[1].textContent = studentData.name;
            cells[2].textContent = studentData.email || '-';
            
            // Обновляем onclick атрибуты
            const editBtn = cells[3].querySelector('button[onclick*="editStudent"]');
            const deleteBtn = cells[3].querySelector('button[onclick*="deleteStudent"]');
            
            if (editBtn) {
                editBtn.setAttribute('onclick', `editStudent(${studentId}, '${studentData.name}', '${studentData.email || ''}')`);
            }
            if (deleteBtn) {
                deleteBtn.setAttribute('onclick', `deleteStudent(${studentId}, '${studentData.name}')`);
            }
        }
        
        // Пересортируем таблицу после обновления имени
        sortTableRows();
        
        showSuccessNotification('Студент обновлен');
    } else {
        console.error('Строка студента не найдена для обновления');
        showSuccessNotification('Студент обновлен в базе данных');
    }
}

function removeStudentFromTable(studentId) {
    // Находим и удаляем строку с нужным студентом по data-атрибуту
    const rowToRemove = document.querySelector(`tr[data-student-id="${studentId}"]`);
    
    if (rowToRemove) {
        rowToRemove.remove();
        
        // Обновляем номера строк
        const remainingRows = document.querySelectorAll('table tbody tr');
        remainingRows.forEach((row, index) => {
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) {
                firstCell.textContent = index + 1;
            }
        });
        
        // Обновляем счетчик студентов
        const studentsCount = document.querySelector('.text-primary');
        if (studentsCount) {
            const currentCount = parseInt(studentsCount.textContent);
            studentsCount.textContent = currentCount - 1;
        }
        
        // Если студентов не осталось, показываем сообщение
        if (remainingRows.length === 0) {
            const noStudentsDiv = document.querySelector('.text-center.py-4');
            if (noStudentsDiv) {
                noStudentsDiv.style.display = 'block';
            }
            const tableContainer = document.querySelector('.table-responsive');
            if (tableContainer) {
                tableContainer.style.display = 'none';
            }
        }
        
        showSuccessNotification('Студент удален');
    } else {
        console.error('Строка студента не найдена для удаления');
        showSuccessNotification('Студент удален из базы данных');
    }
}

function addStudent() {
    const name = document.getElementById('studentName').value;
    const email = document.getElementById('studentEmail').value;
    
    if (!name.trim()) {
        alert('Введите имя студента');
        return;
    }
    
    fetch(`/groups/{{ group.id }}/students`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
            if (modal) {
                modal.hide();
            }
            
            // Обновляем список студентов на странице
            updateStudentsList([data.student]);
        } else {
            alert(data.error || 'Ошибка при добавлении студента');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении студента');
    });
}

function addStudentsBatch() {
    const studentsText = document.getElementById('studentsText').value;
    
    if (!studentsText.trim()) {
        alert('Введите список студентов');
        return;
    }
    
    fetch(`/groups/{{ group.id }}/students/batch`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            students_text: studentsText
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Batch add response:', data);
        
        const resultDiv = document.getElementById('batchResult');
        const successDiv = document.getElementById('batchSuccess');
        const errorsDiv = document.getElementById('batchErrors');
        
        // Проверяем, что элементы существуют
        if (!resultDiv || !successDiv || !errorsDiv) {
            console.error('Required DOM elements not found');
            // Даже если этих блоков нет, продолжаем: закрываем модалку и пробуем обновить список
        }
        
        if (resultDiv) {
            resultDiv.style.display = 'block';
        }
        
        // Скрываем предыдущие сообщения
        if (successDiv) successDiv.style.display = 'none';
        if (errorsDiv) errorsDiv.style.display = 'none';
        
        // Показываем успешные добавления
        if (typeof data.added_count === 'number' && data.added_count > 0 && successDiv) {
            const list = Array.isArray(data.students) ? data.students : [];
            successDiv.innerHTML = `<strong>Успешно добавлено ${data.added_count} студентов:</strong><br>` + 
                list.map(s => `• ${s.name}${s.email ? ' (' + s.email + ')' : ''}`).join('<br>');
            successDiv.style.display = 'block';
        } else if (typeof data.total_processed === 'number' && data.total_processed > 0 && successDiv) {
            // Если обработали студентов, но никого не добавили
            successDiv.innerHTML = '<strong>Ни один студент не был добавлен</strong><br>Возможно, все студенты уже существуют в группе';
            successDiv.style.display = 'block';
        }
        
        // Показываем ошибки
        if (data.errors && data.errors.length > 0 && errorsDiv) {
            errorsDiv.innerHTML = '<strong>Ошибки:</strong><br>' + data.errors.join('<br>');
            errorsDiv.style.display = 'block';
        }
        
        // Готовим массив студентов для локального обновления UI при разных форматах ответа
        let studentsArray = [];
        if (Array.isArray(data.students)) {
            studentsArray = data.students;
        } else if (Array.isArray(data.added)) {
            studentsArray = data.added.map(s => typeof s === 'string' ? ({ name: s, email: '-' }) : s);
        }

        // Закрываем модальное окно в любом успешном сценарии
        const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentsBatchModal'));
        if (modal) {
            modal.hide();
        }

        // Очищаем поле ввода
        const textarea = document.getElementById('studentsText');
        if (textarea) textarea.value = '';

        // Обновляем список на странице без перезагрузки
        if (studentsArray.length > 0) {
            updateStudentsList(studentsArray);
        } else {
            // Если сервер не вернул конкретные записи, перезагрузим список из API
            reloadStudentsList();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при добавлении студентов');
    });
}

function editStudent(id, name, email) {
    currentStudentId = id;
    document.getElementById('editStudentName').value = name;
    document.getElementById('editStudentEmail').value = email;
    new bootstrap.Modal(document.getElementById('editStudentModal')).show();
}

function saveStudent() {
    const name = document.getElementById('editStudentName').value;
    const email = document.getElementById('editStudentEmail').value;
    
    if (!name.trim()) {
        alert('Введите имя студента');
        return;
    }
    
    fetch(`/groups/{{ group.id }}/students/${currentStudentId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            name: name,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Закрываем модальное окно
            const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
            if (modal) {
                modal.hide();
            }
            
            // Обновляем строку в таблице
            updateStudentInTable(currentStudentId, data.student);
        } else {
            alert(data.error || 'Ошибка при сохранении студента');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при сохранении студента');
    });
}

function deleteStudent(id, name) {
    currentStudentId = id;
    document.getElementById('studentNameToDelete').textContent = name;
    new bootstrap.Modal(document.getElementById('deleteStudentModal')).show();
}

document.getElementById('confirmDeleteStudent').addEventListener('click', function() {
    if (currentStudentId) {
        fetch(`/groups/{{ group.id }}/students/${currentStudentId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Закрываем модальное окно
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteStudentModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Удаляем строку из таблицы
                removeStudentFromTable(currentStudentId);
            } else {
                alert('Ошибка при удалении студента');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при удалении студента');
        });
    }
});
</script>
{% endblock %}




