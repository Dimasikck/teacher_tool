{% extends 'base.html' %}
{% block title %}–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è{% endblock %}

{% block extra_css %}
<style>
    .communications-header {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .communications-card {
        border-radius: 20px;
        border: 1px solid var(--border-light);
        background: var(--bg-card);
        box-shadow: 0 15px 50px rgba(15, 52, 96, 0.08);
        padding: 1.75rem;
    }

    .messenger-tabs .nav-link {
        border-radius: 16px;
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        border: 1px solid transparent;
    }

    .messenger-tabs .nav-link i {
        font-size: 1.25rem;
    }

    .messenger-tabs .nav-link.active {
        background: var(--accent-gradient);
        color: #fff;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    .messenger-status {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        font-size: 0.9rem;
        border-radius: 999px;
        padding: 0.35rem 0.85rem;
        font-weight: 600;
    }

    .messenger-status.online {
        background: rgba(34, 197, 94, 0.15);
        color: #16a34a;
    }

    .messenger-status.warning {
        background: rgba(251, 191, 36, 0.18);
        color: #b45309;
    }

    .messenger-status.offline {
        background: rgba(239, 68, 68, 0.15);
        color: #b91c1c;
    }

    .chat-preview {
        border: 1px dashed var(--border-light);
        border-radius: 18px;
        padding: 1.25rem;
        background: var(--bg-secondary);
        min-height: 220px;
    }

    .chat-message {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 14px;
        margin-bottom: 0.75rem;
        position: relative;
        box-shadow: 0 10px 20px rgba(15, 52, 96, 0.08);
    }

    .chat-message.me {
        margin-left: auto;
        background: var(--accent-gradient);
        color: #fff;
    }

    .chat-message.them {
        background: var(--bg-card);
        border: 1px solid var(--border-light);
    }

    .integration-checklist {
        border-radius: 18px;
        background: var(--bg-secondary);
        padding: 1rem 1.25rem;
    }

    .integration-checklist li {
        margin-bottom: 0.35rem;
    }

    @media (max-width: 992px) {
        .communications-card {
            padding: 1.25rem;
        }

        .messenger-tabs {
            flex-direction: column;
        }

        .messenger-tabs .nav-link {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="communications-header mb-4">
    <h1 class="mb-0">–ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è</h1>
    <p class="text-muted mb-0">–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —á–∞—Ç–∞–º–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–æ–≤ –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å–æ —Å—Ç—É–¥–µ–Ω—Ç–∞–º–∏ –≤ –æ–¥–Ω–æ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ.</p>
</div>

<div class="communications-card">
    <ul class="nav nav-pills messenger-tabs gap-2 mb-4" id="messengerTabs" role="tablist">
        {% for channel in channels %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if loop.first %}active{% endif %}"
                    id="tab-btn-{{ channel.id }}"
                    data-bs-toggle="pill"
                    data-bs-target="#tab-{{ channel.id }}"
                    type="button"
                    role="tab"
                    aria-controls="tab-{{ channel.id }}"
                    aria-selected="{{ 'true' if loop.first else 'false' }}">
                <i class="bi {{ channel.icon }}"></i>
                {{ channel.name }}
            </button>
        </li>
        {% endfor %}
    </ul>

    <div class="tab-content" id="messengerTabsContent">
        {% for channel in channels %}
        <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="tab-{{ channel.id }}" role="tabpanel" aria-labelledby="tab-btn-{{ channel.id }}">
            <div class="row g-4 align-items-stretch">
                <div class="col-lg-8">
                    <div class="h-100 d-flex flex-column gap-4">
                        <div>
                            <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
                                <span class="messenger-status {{ channel.status }}" id="status-{{ channel.id }}">
                                    <span class="status-dot"></span>
                                    <span id="status-text-{{ channel.id }}">{{ channel.status_text }}</span>
                                </span>
                                {% if channel.status == 'online' %}
                                <button class="btn btn-sm btn-outline-primary" onclick="syncMessenger('{{ channel.id }}')">
                                    <i class="bi bi-arrow-repeat"></i> –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                {% endif %}
                                <button class="btn btn-sm btn-outline-secondary" onclick="openSettingsModal('{{ channel.id }}')">
                                    <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å
                                </button>
                            </div>
                            <p class="text-muted mb-0">{{ channel.description }}</p>
                        </div>

                        <div class="chat-preview">
                            <div class="chat-message them">
                                <small class="d-block text-muted mb-1">–°—Ç—É–¥–µ–Ω—Ç—ã</small>
                                –ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ù–∞–ø–æ–º–Ω–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ –∫–∞–∫–æ–≥–æ —á–∏—Å–ª–∞ —Å–¥–∞–≤–∞—Ç—å –ø—Ä–æ–µ–∫—Ç?
                            </div>
                            <div class="chat-message me">
                                <small class="d-block text-light mb-1">–í—ã</small>
                                –î–æ –ø—è—Ç–Ω–∏—Ü—ã, 25 —á–∏—Å–ª–∞. –°—Å—ã–ª–∫—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è—é –∑–¥–µ—Å—å üëá
                            </div>
                            <div class="chat-message them mb-0">
                                <small class="d-block text-muted mb-1">–°—Ç—É–¥–µ–Ω—Ç—ã</small>
                                –°–ø–∞—Å–∏–±–æ! –í—Å–µ –ø–æ–Ω—è–ª–∏.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="integration-checklist mb-4">
                        <h6 class="fw-semibold mb-3">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h6>
                        <ul class="list-unstyled mb-0">
                            {% for action in channel.actions %}
                            <li class="d-flex align-items-center gap-2">
                                <i class="bi bi-check-circle text-success"></i>
                                <span>{{ action }}</span>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="p-3 rounded-4 border border-dashed text-center h-100 d-flex flex-column justify-content-center" style="border-color: var(--border-light);">
                        <p class="text-muted mb-3">–•–æ—Ç–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è {{ channel.name }}?</p>
                        <button class="btn btn-primary w-100" onclick="openSettingsModal('{{ channel.id }}')">
                            <i class="bi bi-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é
                        </button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalTitle">
                    <i class="bi bi-gear"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <input type="hidden" id="messengerType" name="messenger_type">
                    
                    <!-- WhatsApp –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div id="whatsappSettings" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Instance ID</label>
                            <input type="text" class="form-control" id="whatsappInstanceId" name="instance_id" placeholder="–í–≤–µ–¥–∏—Ç–µ Instance ID">
                            <div class="form-text">Instance ID –∏–∑ WhatsApp Business API</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Token</label>
                            <input type="text" class="form-control" id="whatsappApiToken" name="api_token" placeholder="–í–≤–µ–¥–∏—Ç–µ API Token">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                            <input type="text" class="form-control" id="whatsappPhone" name="phone_number" placeholder="+79991234567">
                        </div>
                    </div>
                    
                    <!-- Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div id="telegramSettings" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Bot Token</label>
                            <input type="text" class="form-control" id="telegramApiToken" name="api_token" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                            <div class="form-text">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É <a href="https://t.me/BotFather" target="_blank">@BotFather</a></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API ID (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" class="form-control" id="telegramApiId" name="api_id" placeholder="–í–≤–µ–¥–∏—Ç–µ API ID">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Hash (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <input type="text" class="form-control" id="telegramApiHash" name="api_hash" placeholder="–í–≤–µ–¥–∏—Ç–µ API Hash">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username –±–æ—Ç–∞</label>
                            <input type="text" class="form-control" id="telegramBotUsername" name="bot_username" placeholder="@my_bot">
                        </div>
                    </div>
                    
                    <!-- Max –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
                    <div id="maxSettings" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">API Token</label>
                            <input type="text" class="form-control" id="maxApiToken" name="api_token" placeholder="–í–≤–µ–¥–∏—Ç–µ API Token">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Webhook URL</label>
                            <input type="url" class="form-control" id="maxWebhookUrl" name="webhook_url" placeholder="https://example.com/webhook">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="isActive" name="is_active">
                            <label class="form-check-label" for="isActive">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ</label>
                        </div>
                    </div>
                    
                    <div id="testResult" class="mb-3"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-info" onclick="testMessengerConnection()">
                    <i class="bi bi-wifi"></i> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="saveMessengerSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentMessengerType = null;

function openSettingsModal(messengerType) {
    currentMessengerType = messengerType;
    const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
    document.getElementById('messengerType').value = messengerType;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    document.getElementById('whatsappSettings').style.display = 'none';
    document.getElementById('telegramSettings').style.display = 'none';
    document.getElementById('maxSettings').style.display = 'none';
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    if (messengerType === 'whatsapp') {
        document.getElementById('whatsappSettings').style.display = 'block';
        document.getElementById('settingsModalTitle').innerHTML = '<i class="bi bi-whatsapp"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WhatsApp';
    } else if (messengerType === 'telegram') {
        document.getElementById('telegramSettings').style.display = 'block';
        document.getElementById('settingsModalTitle').innerHTML = '<i class="bi bi-telegram"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram';
    } else if (messengerType === 'max') {
        document.getElementById('maxSettings').style.display = 'block';
        document.getElementById('settingsModalTitle').innerHTML = '<i class="bi bi-chat-dots"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Max';
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    loadMessengerSettings(messengerType);
    modal.show();
}

function loadMessengerSettings(messengerType) {
    fetch(`/communications/api/settings/${messengerType}`)
        .then(r => r.json())
        .then(data => {
            if (messengerType === 'whatsapp') {
                document.getElementById('whatsappInstanceId').value = data.instance_id || '';
                document.getElementById('whatsappApiToken').value = data.api_token || '';
                document.getElementById('whatsappPhone').value = data.phone_number || '';
            } else if (messengerType === 'telegram') {
                document.getElementById('telegramApiToken').value = data.api_token || '';
                document.getElementById('telegramApiId').value = data.api_id || '';
                document.getElementById('telegramApiHash').value = data.api_hash || '';
                document.getElementById('telegramBotUsername').value = data.bot_username || '';
            } else if (messengerType === 'max') {
                document.getElementById('maxApiToken').value = data.api_token || '';
                document.getElementById('maxWebhookUrl').value = data.webhook_url || '';
            }
            document.getElementById('isActive').checked = data.is_active || false;
        })
        .catch(err => {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', err);
            showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
        });
}

function saveMessengerSettings() {
    const messengerType = document.getElementById('messengerType').value;
    const formData = {
        is_active: document.getElementById('isActive').checked
    };
    
    if (messengerType === 'whatsapp') {
        formData.instance_id = document.getElementById('whatsappInstanceId').value;
        formData.api_token = document.getElementById('whatsappApiToken').value;
        formData.phone_number = document.getElementById('whatsappPhone').value;
    } else if (messengerType === 'telegram') {
        formData.api_token = document.getElementById('telegramApiToken').value;
        formData.api_id = document.getElementById('telegramApiId').value;
        formData.api_hash = document.getElementById('telegramApiHash').value;
        formData.bot_username = document.getElementById('telegramBotUsername').value;
    } else if (messengerType === 'max') {
        formData.api_token = document.getElementById('maxApiToken').value;
        formData.webhook_url = document.getElementById('maxWebhookUrl').value;
    }
    
    fetch(`/communications/api/settings/${messengerType}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è', 'danger');
        }
    })
    .catch(err => {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', err);
        showToast('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'danger');
    });
}

function testMessengerConnection() {
    const messengerType = document.getElementById('messengerType').value;
    const resultDiv = document.getElementById('testResult');
    resultDiv.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...';
    
    fetch(`/communications/api/test-connection/${messengerType}`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success mb-0"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> ${data.error || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}</div>`;
        }
    })
    .catch(err => {
        console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', err);
        resultDiv.innerHTML = '<div class="alert alert-danger mb-0"><i class="bi bi-x-circle"></i> –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</div>';
    });
}

function syncMessenger(messengerType) {
    fetch(`/communications/api/sync/${messengerType}`, {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'danger');
        }
    })
    .catch(err => {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:', err);
        showToast('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏', 'danger');
    });
}

function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = 2000;
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    // –°—Ç–∞—Ç—É—Å—ã —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞ –≤ —à–∞–±–ª–æ–Ω–µ
});
</script>
{% endblock %}


