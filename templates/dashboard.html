{% extends "base.html" %}
{% block title %}Главная{% endblock %}

{% block content %}
<h1 class="mb-4">Панель управления</h1>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card bg-primary text-white clickable-card" onclick="navigateToGroups()">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people"></i> Группы</h5>
                <h2>{{ groups }}</h2>
                <small class="d-block mt-2"><i class="bi bi-arrow-right"></i> Управление группами</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-success text-white clickable-card" onclick="navigateToStudents()">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-person"></i> Студенты</h5>
                <h2>{{ students }}</h2>
                <small class="d-block mt-2"><i class="bi bi-arrow-right"></i> Журнал посещаемости</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-warning text-white clickable-card" onclick="navigateToLessons()">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-book"></i> Занятия</h5>
                <h2>{{ lessons }}</h2>
                <small class="d-block mt-2"><i class="bi bi-arrow-right"></i> Календарь занятий</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card bg-info text-white clickable-card" onclick="navigateToAssignments()">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-file-text"></i> Задания</h5>
                <h2>{{ assignments }}</h2>
                {% if unchecked > 0 %}
                <small>Непроверенных: {{ unchecked }}</small>
                {% endif %}
                <small class="d-block mt-2"><i class="bi bi-arrow-right"></i> Управление заданиями</small>
            </div>
        </div>
    </div>
</div>

<!-- График занятий по времени -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">График занятий по времени</h5>
                <div class="btn-group" role="group" aria-label="Период">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="periodDay" onclick="changePeriod('day')">Дни</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" id="periodWeek" onclick="changePeriod('week')">Недели</button>
                    <button type="button" class="btn btn-primary btn-sm" id="periodMonth" onclick="changePeriod('month')">Месяцы</button>
                </div>
            </div>
            <div class="card-body chart-container" style="height: 380px;">
                <canvas id="lessonsTimelineChart"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Статистика посещаемости</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="expandChart('attendance')">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="card-body chart-container" style="height: 320px;">
                <canvas id="attendanceChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Статистика успеваемости</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="expandChart('scores')">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="card-body chart-container" style="height: 320px;">
                <canvas id="scoresChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Выполнение заданий</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="expandChart('assignments')">
                    <i class="bi bi-arrows-fullscreen"></i>
                </button>
            </div>
            <div class="card-body chart-container" style="height: 320px;">
                <canvas id="assignmentsChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для развернутых диаграмм -->
<div class="modal fade" id="chartModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chartModalTitle">Диаграмма</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="height: 70vh;">
                <canvas id="expandedChart"></canvas>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>

<style>
.clickable-card {
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.clickable-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.clickable-card:hover::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.clickable-card:hover::before {
    left: 100%;
}

.clickable-card:active {
    transform: translateY(-2px);
}

.stat-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.stat-card .card-body {
    padding: 1.5rem;
}

.stat-card h5 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.stat-card h2 {
    font-weight: 700;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
}

.stat-card small {
    opacity: 0.9;
    font-weight: 500;
}

/* Плавная загрузка графиков */
.chart-container {
    position: relative;
    overflow: hidden;
}

.chart-container canvas {
    opacity: 0;
    transform: translateY(12px) scale(0.97);
    transition: opacity 0.6s ease-out, transform 0.6s ease-out;
}

.chart-container canvas.chart-loaded {
    opacity: 1;
    transform: translateY(0) scale(1);
}

.chart-container.loading canvas {
    opacity: 0 !important;
    transform: translateY(12px) scale(0.97) !important;
}

.chart-container.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 48px;
    height: 48px;
    margin: -24px 0 0 -24px;
    border-radius: 50%;
    border: 3px solid rgba(102, 126, 234, 0.2);
    border-top-color: #667eea;
    animation: spin 0.9s linear infinite;
    box-shadow: 0 0 30px rgba(102, 126, 234, 0.35);
}

.chart-container.loading::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(120deg, rgba(102,126,234,0.08), rgba(118,75,162,0.08));
    backdrop-filter: blur(3px);
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Анимация при наведении */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.clickable-card:hover {
    animation: pulse 0.6s ease-in-out;
}
</style>

<script>
// Функции навигации
function navigateToGroups() {
    window.location.href = '/groups';
}

function navigateToStudents() {
    window.location.href = '/journal';
}

function navigateToAssignments() {
    window.location.href = '/assignments';
}

function navigateToLessons() {
    window.location.href = '/calendar';
}

// Управление загрузкой графиков
function setChartLoading(canvasId, isLoading) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const container = canvas.closest('.chart-container');
    if (!container) return;

    if (isLoading) {
        container.classList.add('loading');
        canvas.classList.remove('chart-loaded');
    } else {
        container.classList.remove('loading');
        requestAnimationFrame(() => {
            canvas.classList.add('chart-loaded');
        });
    }
}

// Переменные для графиков
let lessonsTimelineChart = null;
let attendanceChart = null;
let scoresChart = null;
let assignmentsChart = null;
let expandedChart = null;
let currentPeriod = 'month';

// Функция переключения периода
function changePeriod(period) {
    currentPeriod = period;
    
    // Обновляем активную кнопку
    document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline-primary');
    });
    document.getElementById(`period${period.charAt(0).toUpperCase() + period.slice(1)}`).classList.remove('btn-outline-primary');
    document.getElementById(`period${period.charAt(0).toUpperCase() + period.slice(1)}`).classList.add('btn-primary');
    
    // Загружаем новые данные
    loadLessonsTimeline();
}

// Функция загрузки данных для графика занятий
function loadLessonsTimeline() {
    setChartLoading('lessonsTimelineChart', true);

    fetch(`/api/analytics/lessons-timeline?period=${currentPeriod}`)
        .then(r => r.json())
        .then(data => {
            const ctx = document.getElementById('lessonsTimelineChart');
            
            // Уничтожаем предыдущий график
            if (lessonsTimelineChart) {
                lessonsTimelineChart.destroy();
            }
            
            // Создаем новый график
            lessonsTimelineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Количество занятий',
                        data: data.data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: '#667eea',
                        pointHoverBorderColor: '#ffffff',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    animation: {
                        duration: 1100,
                        easing: 'easeOutQuart',
                        delay: function(context) {
                            // Плавное «прорисовывание» линии слева направо
                            if (context.type === 'data' && context.mode === 'default') {
                                return context.dataIndex * 60;
                            }
                            return 0;
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            callbacks: {
                                title: function(context) {
                                    const label = context[0].label;
                                    if (currentPeriod === 'day') {
                                        return `Дата: ${label}`;
                                    } else if (currentPeriod === 'week') {
                                        return `Неделя: ${label}`;
                                    } else {
                                        return `Месяц: ${label}`;
                                    }
                                },
                                label: function(context) {
                                    const count = context.parsed.y;
                                    const periodName = currentPeriod === 'day' ? 'день' : 
                                                     currentPeriod === 'week' ? 'неделю' : 'месяц';
                                    return `Занятий за ${periodName}: ${count}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                maxTicksLimit: currentPeriod === 'day' ? 8 : currentPeriod === 'week' ? 6 : 10,
                                maxRotation: currentPeriod === 'week' ? 45 : 0,
                                minRotation: 0,
                                font: {
                                    size: currentPeriod === 'week' ? 10 : 12
                                }
                            },
                            grid: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-light'),
                                drawBorder: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary'),
                                stepSize: 1
                            },
                            grid: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('--border-light'),
                                drawBorder: false
                            },
                            title: {
                                display: true,
                                text: 'Количество занятий',
                                color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            setChartLoading('lessonsTimelineChart', false);
        })
        .catch(error => {
            console.error('Ошибка загрузки данных графика занятий:', error);
            setChartLoading('lessonsTimelineChart', false);
        });
}

// Загрузка аналитики
fetch('/api/analytics/overview')
    .then(r => r.json())
    .then(data => {
        // Загружаем график занятий по времени
        loadLessonsTimeline();
        // Загрузим ежемесячную статистику посещаемости (stacked)
        setChartLoading('attendanceChart', true);
        fetch('/api/analytics/attendance-monthly')
            .then(r => r.json())
            .then(monthly => {
                const ctx = document.getElementById('attendanceChart');
                if (attendanceChart) attendanceChart.destroy();
                attendanceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: monthly.labels,
                        datasets: [
                            {
                                label: 'Присутствовали',
                                data: monthly.present,
                                backgroundColor: '#28a745'
                            },
                            {
                                label: 'Отсутствовали',
                                data: monthly.absent,
                                backgroundColor: '#dc3545'
                            }
                        ]
                    },
                    options: {
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            delay: function(context) {
                                // Плавное нарастание столбцов по оси X
                                if (context.type === 'data' && context.mode === 'default') {
                                    return context.dataIndex * 50;
                                }
                                return 0;
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }
                            },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') }
                            }
                        }
                    }
                });

                setChartLoading('attendanceChart', false);
            })
            .catch(err => {
                console.error('Ошибка загрузки посещаемости:', err);
                setChartLoading('attendanceChart', false);
            });

        // Загрузим общую статистику успеваемости по группам из журнала (горизонтальные полосы с накоплением)
        setChartLoading('scoresChart', true);
        fetch('/api/analytics/scores-by-group')
            .then(r => r.json())
            .then(series => {
                const ctx2 = document.getElementById('scoresChart');
                if (scoresChart) scoresChart.destroy();
                scoresChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: series.labels,
                        datasets: [
                            { label: 'Отлично (85-100%)', data: series.excellent, backgroundColor: '#198754' },
                            { label: 'Хорошо (70-84%)', data: series.good, backgroundColor: '#0d6efd' },
                            { label: 'Удовлетворительно (55-69%)', data: series.average, backgroundColor: '#ffc107' },
                            { label: 'Неудовлетворительно (<55%)', data: series.low, backgroundColor: '#dc3545' }
                        ]
                    },
                    options: {
                        indexAxis: 'y', // Горизонтальные полосы
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            delay: function(context) {
                                // Полосы появляются сверху вниз
                                if (context.type === 'data' && context.mode === 'default') {
                                    return context.dataIndex * 40;
                                }
                                return 0;
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'top', labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') } },
                            tooltip: { 
                                mode: 'index', 
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.x;
                                        return `${label}: ${value} оценок`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                stacked: true, 
                                beginAtZero: true, 
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, 
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Количество оценок',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            y: { 
                                stacked: true, 
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }, 
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Группы',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });

                setChartLoading('scoresChart', false);
            })
            .catch(err => {
                console.error('Ошибка загрузки успеваемости:', err);
                setChartLoading('scoresChart', false);
            });

        // Загрузим статистику выполнения заданий по группам
        setChartLoading('assignmentsChart', true);
        fetch('/api/analytics/assignments-by-group')
            .then(r => r.json())
            .then(data => {
                const ctx3 = document.getElementById('assignmentsChart');
                if (assignmentsChart) assignmentsChart.destroy();
                assignmentsChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Выполненные',
                                data: data.completed,
                                backgroundColor: '#28a745'
                            },
                            {
                                label: 'Невыполненные',
                                data: data.uncompleted,
                                backgroundColor: '#dc3545'
                            }
                        ]
                    },
                    options: {
                        animation: {
                            duration: 1000,
                            easing: 'easeOutQuart',
                            delay: function(context) {
                                if (context.type === 'data' && context.mode === 'default') {
                                    return context.dataIndex * 50;
                                }
                                return 0;
                            }
                        },
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') }
                            },
                            tooltip: { 
                                mode: 'index', 
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        const label = context.dataset.label || '';
                                        const value = context.parsed.y;
                                        return `${label}: ${value} заданий`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Группы',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true,
                                ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') },
                                grid: { color: getComputedStyle(document.documentElement).getPropertyValue('--border-light') },
                                title: {
                                    display: true,
                                    text: 'Количество заданий',
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary')
                                }
                            }
                        }
                    }
                });
                setChartLoading('assignmentsChart', false);
            })
            .catch(err => {
                console.error('Ошибка загрузки заданий:', err);
                setChartLoading('assignmentsChart', false);
            });

    });

// Функция для разворачивания диаграмм
function expandChart(chartType) {
    const modal = new bootstrap.Modal(document.getElementById('chartModal'));
    const title = document.getElementById('chartModalTitle');
    const canvas = document.getElementById('expandedChart');
    
    // Уничтожаем предыдущую диаграмму
    if (expandedChart) {
        expandedChart.destroy();
    }
    
    let sourceChart = null;
    let chartTitle = '';
    
    switch(chartType) {
        case 'attendance':
            sourceChart = attendanceChart;
            chartTitle = 'Статистика посещаемости';
            break;
        case 'scores':
            sourceChart = scoresChart;
            chartTitle = 'Статистика успеваемости';
            break;
        case 'assignments':
            sourceChart = assignmentsChart;
            chartTitle = 'Выполнение заданий';
            break;
    }
    
    if (!sourceChart) {
        alert('Диаграмма еще не загружена');
        return;
    }
    
    title.textContent = chartTitle;
    
    // Создаем новую конфигурацию на основе исходной диаграммы
    const config = {
        type: sourceChart.config.type,
        data: {
            labels: [...sourceChart.data.labels],
            datasets: sourceChart.data.datasets.map(dataset => ({
                ...dataset,
                data: [...dataset.data]
            }))
        },
        options: {
            ...sourceChart.config.options,
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                ...sourceChart.config.options.plugins,
                legend: {
                    ...sourceChart.config.options.plugins.legend,
                    display: true
                }
            }
        }
    };
    
    // Создаем новую диаграмму в модальном окне
    expandedChart = new Chart(canvas, config);
    
    modal.show();
}
</script>
{% endblock %}